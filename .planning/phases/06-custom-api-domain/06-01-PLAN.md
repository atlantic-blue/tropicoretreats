---
phase: 06-custom-api-domain
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/api/main.tf
  - infra/api/outputs.tf
  - infra/api/variables.tf
  - infra/main.tf
  - infra/api-route53.tf
  - frontend/.env
  - admin/.env
autonomous: true

must_haves:
  truths:
    - "API requests to api.tropicoretreat.com/v1/leads return valid responses"
    - "HTTPS certificate is valid (no browser warnings)"
    - "Existing API functionality unchanged (contact form still works)"
    - "Rate limiting returns 429 when exceeded"
    - "Old execute-api endpoint continues working after deployment"
  artifacts:
    - path: "infra/api/main.tf"
      provides: "Custom domain, API mapping, throttling"
      contains: "aws_apigatewayv2_domain_name"
    - path: "infra/api/outputs.tf"
      provides: "Domain outputs for Route53"
      exports: ["api_domain_target", "api_domain_zone_id"]
    - path: "infra/api-route53.tf"
      provides: "DNS record for api subdomain"
      contains: "aws_route53_record"
  key_links:
    - from: "infra/api-route53.tf"
      to: "infra/api/main.tf"
      via: "module.api.api_domain_target"
      pattern: "module\\.api\\.api_domain"
    - from: "frontend/.env"
      to: "api.tropicoretreat.com"
      via: "API_URL environment variable"
      pattern: "api\\.tropicoretreat\\.com"
---

<objective>
Configure custom domain api.tropicoretreat.com for the API Gateway HTTP API with /v1 versioning prefix and rate limiting.

Purpose: Establish branded, stable API URLs for external integrations (Twilio webhooks in later phases) and provide basic rate limiting protection.

Output: Working custom domain with HTTPS, /v1 base path, 10 req/sec rate limiting, and updated frontend configurations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-custom-api-domain/06-CONTEXT.md
@.planning/phases/06-custom-api-domain/06-RESEARCH.md
@infra/api/main.tf
@infra/api/outputs.tf
@infra/acm.tf
@infra/admin-route53.tf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add custom domain, API mapping, and throttling to Terraform</name>
  <files>infra/api/main.tf, infra/api/outputs.tf, infra/api/variables.tf, infra/main.tf</files>
  <action>
Update infra/api/main.tf to add:

1. Custom domain resource using existing wildcard certificate:
```hcl
resource "aws_apigatewayv2_domain_name" "api" {
  domain_name = "api.${local.domain_name}"

  domain_name_configuration {
    certificate_arn = var.wildcard_certificate_arn
    endpoint_type   = "REGIONAL"
    security_policy = "TLS_1_2"
  }

  tags = local.tags
}
```

2. API mapping with /v1 base path:
```hcl
resource "aws_apigatewayv2_api_mapping" "v1" {
  api_id          = aws_apigatewayv2_api.leads.id
  domain_name     = aws_apigatewayv2_domain_name.api.id
  stage           = aws_apigatewayv2_stage.default.id
  api_mapping_key = "v1"
}
```

3. Update existing aws_apigatewayv2_stage.default to add throttling:
```hcl
default_route_settings {
  throttling_burst_limit = 10
  throttling_rate_limit  = 10
}
```

4. Add variable for certificate ARN in infra/api/variables.tf:
```hcl
variable "wildcard_certificate_arn" {
  description = "ARN of the wildcard ACM certificate for *.tropicoretreat.com"
  type        = string
}
```

5. Update infra/main.tf module call to pass certificate:
```hcl
module "api" {
  source = "./api"

  environment              = var.environment
  product_name             = var.product_name
  aws_region               = var.aws_region
  wildcard_certificate_arn = aws_acm_certificate.www_certificate.arn
}
```

6. Add outputs in infra/api/outputs.tf for Route53:
```hcl
output "api_domain_target" {
  description = "Target domain name for Route53 alias"
  value       = aws_apigatewayv2_domain_name.api.domain_name_configuration[0].target_domain_name
}

output "api_domain_zone_id" {
  description = "Hosted zone ID for Route53 alias"
  value       = aws_apigatewayv2_domain_name.api.domain_name_configuration[0].hosted_zone_id
}
```

IMPORTANT: Never remove throttling settings once added - this would set limits to 0 and block all traffic (known Terraform bug per RESEARCH.md).
  </action>
  <verify>
Run `cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/infra && terraform validate` to check syntax.
Run `terraform plan` and verify:
- aws_apigatewayv2_domain_name.api will be created
- aws_apigatewayv2_api_mapping.v1 will be created
- aws_apigatewayv2_stage.default shows throttling_burst_limit = 10, throttling_rate_limit = 10
  </verify>
  <done>
Terraform plan shows 2 new resources (domain, mapping) and 1 update (stage throttling) with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Route53 record and deploy infrastructure</name>
  <files>infra/api-route53.tf, infra/_outputs.tf</files>
  <action>
1. Create new file infra/api-route53.tf with Route53 alias record:
```hcl
# Route53 record pointing api subdomain to API Gateway custom domain
resource "aws_route53_record" "api" {
  zone_id = aws_route53_zone.www.zone_id
  name    = "api.tropicoretreat.com"
  type    = "A"

  alias {
    name                   = module.api.api_domain_target
    zone_id                = module.api.api_domain_zone_id
    evaluate_target_health = false
  }
}
```

2. Add output to infra/_outputs.tf:
```hcl
output "api_custom_domain" {
  description = "Custom domain URL for the API"
  value       = "https://api.tropicoretreat.com/v1"
}
```

3. Apply infrastructure:
```bash
cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/infra
terraform apply -auto-approve
```

4. Verify DNS propagation (may take 1-2 minutes):
```bash
dig api.tropicoretreat.com +short
```

5. Test custom domain responds:
```bash
curl -I https://api.tropicoretreat.com/v1/leads
```
Expected: Returns 401 Unauthorized (protected route) or valid response - confirms custom domain is working.

6. Verify old execute-api endpoint still works (backwards compatibility):
```bash
curl -I https://u57cra1p8h.execute-api.us-east-1.amazonaws.com/leads
```
Expected: Returns same response as before (401 or 200). The custom domain is an additional route - it does NOT replace or disable the original execute-api endpoint.

7. Test rate limiting (simple load test):
```bash
# Send 15 rapid requests to trigger throttling
for i in {1..15}; do curl -s -o /dev/null -w "%{http_code}\n" https://api.tropicoretreat.com/v1/leads; done
```
Expected: First 10 requests return 401/200, subsequent requests should return 429 (Too Many Requests) once rate limit exceeded.
  </action>
  <verify>
- `terraform apply` completes successfully
- `dig api.tropicoretreat.com +short` returns an IP address
- `curl -I https://api.tropicoretreat.com/v1/leads` returns HTTP response (401 or 200)
- `curl -I https://u57cra1p8h.execute-api.us-east-1.amazonaws.com/leads` still returns HTTP response (old endpoint works)
- Rate limit test: at least one 429 response when sending 15+ rapid requests
  </verify>
  <done>
Custom domain is live, DNS resolves, API responds at api.tropicoretreat.com/v1, old execute-api endpoint continues working, rate limiting confirmed active.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update frontends and verify end-to-end</name>
  <files>frontend/.env, admin/.env</files>
  <action>
1. Update frontend/.env:
Change:
```
API_URL=https://u57cra1p8h.execute-api.us-east-1.amazonaws.com
```
To:
```
API_URL=https://api.tropicoretreat.com/v1
```

2. Update admin/.env:
Change:
```
VITE_API_ENDPOINT=https://u57cra1p8h.execute-api.us-east-1.amazonaws.com
```
To:
```
VITE_API_ENDPOINT=https://api.tropicoretreat.com/v1
```

3. Rebuild and deploy frontend:
```bash
cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/frontend
npm run build
aws s3 sync dist/ s3://tropicoretreat.com --profile atlantic-blue --delete
aws cloudfront create-invalidation --distribution-id E2MSFQRL27B1WY --paths "/*" --profile atlantic-blue
```

4. Rebuild and deploy admin:
```bash
cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/admin
npm run build
aws s3 sync dist/ s3://admin.tropicoretreat.com --profile atlantic-blue --delete
aws cloudfront create-invalidation --distribution-id E2I1AGHOJGDPNL --paths "/*" --profile atlantic-blue
```

5. Verify contact form still works:
- Visit https://tropicoretreat.com/contact
- Submit test form
- Check browser network tab shows request to api.tropicoretreat.com/v1/leads

6. Verify admin dashboard still works:
- Visit https://admin.tropicoretreat.com
- Log in
- Confirm leads load (network tab shows api.tropicoretreat.com/v1/leads)

Note: Get CloudFront distribution IDs from terraform output if different from above.
  </action>
  <verify>
- Frontend build succeeds
- Admin build succeeds
- Contact form submission creates lead (check admin dashboard)
- Admin dashboard loads leads list
- Browser network tab confirms requests go to api.tropicoretreat.com/v1/*
  </verify>
  <done>
Both frontends use new custom domain, contact form works, admin dashboard loads leads.
  </done>
</task>

</tasks>

<verification>
1. **Custom Domain Active:**
   - `curl https://api.tropicoretreat.com/v1/leads` returns response (401 for protected or data if authenticated)

2. **HTTPS Certificate Valid:**
   - `curl -v https://api.tropicoretreat.com/v1/leads 2>&1 | grep "SSL certificate"` shows valid cert
   - No browser warnings when visiting api.tropicoretreat.com

3. **Rate Limiting Active:**
   - Verify in API Gateway console: Stage -> Default Route Settings shows 10/10 throttling
   - Run load test: `for i in {1..15}; do curl -s -o /dev/null -w "%{http_code}\n" https://api.tropicoretreat.com/v1/leads; done`
   - Expect: at least one 429 response when rate limit exceeded

4. **Backwards Compatibility (Old Endpoint):**
   - `curl -I https://u57cra1p8h.execute-api.us-east-1.amazonaws.com/leads` still returns valid response
   - Old endpoint continues working - custom domain is additive, not a replacement

5. **Existing Functionality Unchanged:**
   - Contact form submission creates lead
   - Admin can log in and view leads

6. **API Versioning:**
   - All endpoints accessible at /v1 prefix: /v1/leads, /v1/users, etc.
</verification>

<success_criteria>
- [ ] API requests to api.tropicoretreat.com/v1/* return valid responses
- [ ] HTTPS certificate is valid (curl -v shows no SSL errors)
- [ ] Contact form works with new domain
- [ ] Admin dashboard works with new domain
- [ ] Throttling configured at 10 req/sec (visible in Terraform state and API Gateway console)
- [ ] Rate limiting test shows 429 response when exceeded
- [ ] Old execute-api endpoint still works after deployment
- [ ] No regressions to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-custom-api-domain/06-01-SUMMARY.md` using summary template.
</output>
