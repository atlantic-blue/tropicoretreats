---
phase: 04-admin-auth
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Admin can sign in with email and password"
    - "Protected endpoints accept requests with valid Cognito JWT"
    - "Token refresh works (session persists beyond 1 hour)"
    - "Admin can sign out and token is invalidated"
  artifacts: []
  key_links:
    - from: "Cognito User Pool"
      to: "API Gateway JWT Authorizer"
      via: "JWT token in Authorization header"
      pattern: "Authorization: Bearer"
---

<objective>
Create admin user and verify end-to-end authentication flow.

Purpose: Validate that the Cognito authentication infrastructure works correctly by creating an admin user and testing the complete sign-in, API access, and sign-out flow.

Output: Working admin authentication - user can sign in, access protected endpoints with JWT, refresh tokens work, and sign out invalidates access.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-auth/04-RESEARCH.md
@.planning/phases/04-admin-auth/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin user in Cognito</name>
  <files>None (AWS CLI operation)</files>
  <action>
Create an admin user using AWS CLI:

1. Get the User Pool ID from Terraform output:
```bash
cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/infra
USER_POOL_ID=$(terraform output -raw cognito_user_pool_id)
```

2. Create the admin user (use a test email that can receive the temporary password):
```bash
aws cognito-idp admin-create-user \
  --user-pool-id $USER_POOL_ID \
  --username "admin@tropicoretreat.com" \
  --user-attributes Name=email,Value="admin@tropicoretreat.com" Name=email_verified,Value=true \
  --temporary-password "TempPass123!" \
  --message-action SUPPRESS
```

Note: Using SUPPRESS to avoid sending invite email (we're setting password manually for testing).

3. Verify user created:
```bash
aws cognito-idp admin-get-user \
  --user-pool-id $USER_POOL_ID \
  --username "admin@tropicoretreat.com"
```

The user will be in FORCE_CHANGE_PASSWORD status until they complete first sign-in.
  </action>
  <verify>
`aws cognito-idp admin-get-user --user-pool-id $USER_POOL_ID --username "admin@tropicoretreat.com"` returns user with UserStatus
  </verify>
  <done>
Admin user exists in Cognito User Pool with email admin@tropicoretreat.com
  </done>
</task>

<task type="auto">
  <name>Task 2: Test authentication flow with AWS CLI</name>
  <files>None (AWS CLI operations)</files>
  <action>
Test the complete authentication flow using AWS CLI:

1. Get credentials from Terraform:
```bash
cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/infra
USER_POOL_ID=$(terraform output -raw cognito_user_pool_id)
CLIENT_ID=$(terraform output -raw cognito_client_id)
```

2. Initiate auth (will require password change):
```bash
aws cognito-idp initiate-auth \
  --auth-flow USER_PASSWORD_AUTH \
  --client-id $CLIENT_ID \
  --auth-parameters USERNAME=admin@tropicoretreat.com,PASSWORD=TempPass123!
```

Note: This will fail because we configured SRP_AUTH only. Use admin-initiate-auth instead:

```bash
aws cognito-idp admin-initiate-auth \
  --user-pool-id $USER_POOL_ID \
  --client-id $CLIENT_ID \
  --auth-flow ADMIN_USER_PASSWORD_AUTH \
  --auth-parameters USERNAME=admin@tropicoretreat.com,PASSWORD=TempPass123!
```

Wait - we only allowed USER_SRP_AUTH and REFRESH_TOKEN_AUTH. For CLI testing, we need to either:
- Use SRP (complex with CLI)
- Add ADMIN_USER_PASSWORD_AUTH to the client for testing

**Alternative approach - Set permanent password and enable ADMIN_USER_PASSWORD_AUTH:**

First, update the App Client to allow ADMIN_USER_PASSWORD_AUTH (add to cognito.tf):
```
explicit_auth_flows = [
  "ALLOW_USER_SRP_AUTH",
  "ALLOW_REFRESH_TOKEN_AUTH",
  "ALLOW_ADMIN_USER_PASSWORD_AUTH",  # For CLI testing
]
```

Then run terraform apply.

Then set permanent password:
```bash
aws cognito-idp admin-set-user-password \
  --user-pool-id $USER_POOL_ID \
  --username "admin@tropicoretreat.com" \
  --password "SecureAdminPass123!" \
  --permanent
```

Then initiate auth:
```bash
AUTH_RESULT=$(aws cognito-idp admin-initiate-auth \
  --user-pool-id $USER_POOL_ID \
  --client-id $CLIENT_ID \
  --auth-flow ADMIN_USER_PASSWORD_AUTH \
  --auth-parameters USERNAME=admin@tropicoretreat.com,PASSWORD=SecureAdminPass123!)

ACCESS_TOKEN=$(echo $AUTH_RESULT | jq -r '.AuthenticationResult.AccessToken')
ID_TOKEN=$(echo $AUTH_RESULT | jq -r '.AuthenticationResult.IdToken')
REFRESH_TOKEN=$(echo $AUTH_RESULT | jq -r '.AuthenticationResult.RefreshToken')
```

3. Test protected endpoint with token:
```bash
curl -v "https://u57cra1p8h.execute-api.us-east-1.amazonaws.com/leads" \
  -H "Authorization: Bearer $ACCESS_TOKEN"
```

Should return 200 (or 405 if Lambda doesn't handle GET, but NOT 401).

4. Test without token (should 401):
```bash
curl -s -o /dev/null -w "%{http_code}" "https://u57cra1p8h.execute-api.us-east-1.amazonaws.com/leads"
```

5. Test refresh token:
```bash
aws cognito-idp admin-initiate-auth \
  --user-pool-id $USER_POOL_ID \
  --client-id $CLIENT_ID \
  --auth-flow REFRESH_TOKEN_AUTH \
  --auth-parameters REFRESH_TOKEN=$REFRESH_TOKEN
```

Should return new access token.

6. Test global sign out:
```bash
aws cognito-idp admin-user-global-sign-out \
  --user-pool-id $USER_POOL_ID \
  --username "admin@tropicoretreat.com"
```

After sign out, the refresh token should be invalidated (next refresh attempt should fail).
  </action>
  <verify>
1. Auth returns AccessToken, IdToken, RefreshToken
2. GET /leads with token returns non-401 (200 or 405)
3. GET /leads without token returns 401
4. Refresh token returns new AccessToken
5. Global sign out succeeds
  </verify>
  <done>
Complete auth flow verified: sign-in returns tokens, protected endpoint accepts JWT, refresh works, sign-out invalidates session.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Cognito authentication infrastructure for admin dashboard:
- Cognito User Pool with admin-only user creation
- App Client configured for browser SRP auth
- JWT authorizer protecting GET /leads endpoint
- Admin user created and tested
  </what-built>
  <how-to-verify>
1. **Verify user exists in AWS Console:**
   - Go to AWS Console > Cognito > User Pools > tropico-admin-production
   - Check Users tab shows admin@tropicoretreat.com with CONFIRMED status

2. **Verify authorizer in API Gateway:**
   - Go to AWS Console > API Gateway > tropico-leads-api-production
   - Check Authorization tab shows JWT authorizer
   - Check Routes shows GET /leads with JWT authorization

3. **Test the flow manually (optional):**
   - The AWS CLI commands in Task 2 demonstrate the flow
   - Full browser-based testing will happen in Phase 5 with the admin dashboard

4. **Review Terraform outputs:**
   - User Pool ID and Client ID are captured for Phase 5
  </how-to-verify>
  <resume-signal>Type "approved" if authentication infrastructure is verified, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 4 Plan 02 verification:

1. **Admin user exists:**
   - `aws cognito-idp admin-get-user` returns user details
   - User status is CONFIRMED

2. **Authentication works:**
   - admin-initiate-auth returns valid tokens
   - AccessToken decodes to show correct issuer and audience

3. **Authorization works:**
   - GET /leads + valid token = non-401 response
   - GET /leads + no token = 401 response
   - GET /leads + expired/invalid token = 401 response

4. **Token refresh works:**
   - REFRESH_TOKEN_AUTH flow returns new access token

5. **Sign out works:**
   - admin-user-global-sign-out succeeds
   - Subsequent refresh attempts fail
</verification>

<success_criteria>
- Admin user created in Cognito User Pool
- Sign-in returns access token, ID token, and refresh token
- Protected endpoint (GET /leads) returns 401 without valid JWT
- Protected endpoint accepts requests with valid JWT
- Token refresh returns new access token
- Global sign out invalidates refresh token
- User confirmed authentication flow is working
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-auth/04-02-SUMMARY.md` following the summary template.

Include:
- Admin user email
- Authentication test results
- Token verification results
- User approval of checkpoint
- Ready for Phase 5 (Admin Dashboard) to integrate with Amplify
</output>
