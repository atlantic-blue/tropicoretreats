---
phase: 04-admin-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/api/cognito.tf
  - infra/api/main.tf
  - infra/api/outputs.tf
  - infra/api/variables.tf
autonomous: true

must_haves:
  truths:
    - "Cognito User Pool exists for admin authentication"
    - "JWT authorizer validates tokens against Cognito issuer"
    - "Protected route requires valid JWT to access"
  artifacts:
    - path: "infra/api/cognito.tf"
      provides: "Cognito User Pool and App Client configuration"
      contains: "aws_cognito_user_pool"
    - path: "infra/api/main.tf"
      provides: "JWT authorizer and protected route"
      contains: "aws_apigatewayv2_authorizer"
  key_links:
    - from: "infra/api/main.tf"
      to: "infra/api/cognito.tf"
      via: "authorizer references user pool endpoint and client id"
      pattern: "aws_cognito_user_pool\\.admin\\.(endpoint|id)"
---

<objective>
Create Cognito authentication infrastructure with JWT authorizer for API Gateway.

Purpose: Enable secure admin authentication for the lead management dashboard by deploying Cognito User Pool and integrating with API Gateway HTTP API JWT authorizer.

Output: Deployed Cognito User Pool with admin-only signup, App Client for browser auth, and JWT authorizer protecting the GET /leads endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-auth/04-RESEARCH.md

# Existing infrastructure
@infra/api/main.tf
@infra/api/variables.tf
@infra/api/outputs.tf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cognito User Pool and App Client</name>
  <files>infra/api/cognito.tf, infra/api/outputs.tf</files>
  <action>
Create `infra/api/cognito.tf` with Cognito User Pool and App Client:

**User Pool (`aws_cognito_user_pool.admin`):**
- Name: `tropico-admin-${var.environment}`
- Password policy: minimum 12 chars, require lowercase/uppercase/numbers/symbols
- MFA: OPTIONAL with software token enabled
- Account recovery via verified_email
- Admin-only user creation (`allow_admin_create_user_only = true`)
- Invite message template with subject "Your Tropico Retreats Admin Account" and message containing {username} and {####}
- Email: `email_sending_account = "COGNITO_DEFAULT"` (use Cognito default, not SES initially)
- Auto-verify email attribute
- Schema with required email attribute
- Apply local.tags

**App Client (`aws_cognito_user_pool_client.admin`):**
- Name: `tropico-admin-client-${var.environment}`
- `generate_secret = false` (browser client - NO secret)
- Auth flows: `ALLOW_USER_SRP_AUTH`, `ALLOW_REFRESH_TOKEN_AUTH`
- Token validity: access=1 hour, id=1 hour, refresh=30 days
- `prevent_user_existence_errors = "ENABLED"`
- `enable_token_revocation = true`
- Callback/logout URLs: localhost:3000, localhost:5173, admin.tropicoretreat.com (include localhost in all environments for dev testing)
- Supported identity providers: COGNITO

Add outputs in `infra/api/outputs.tf`:
- `cognito_user_pool_id` = aws_cognito_user_pool.admin.id
- `cognito_user_pool_endpoint` = aws_cognito_user_pool.admin.endpoint
- `cognito_client_id` = aws_cognito_user_pool_client.admin.id

Follow patterns from 04-RESEARCH.md code examples exactly.
  </action>
  <verify>
`cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/infra && terraform validate` passes
  </verify>
  <done>
cognito.tf exists with User Pool (admin-only signup) and App Client (no secret, SRP auth flows).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create JWT Authorizer and protected GET /leads route</name>
  <files>infra/api/main.tf, infra/api/variables.tf</files>
  <action>
Add JWT authorizer and protected route to `infra/api/main.tf`:

**JWT Authorizer (`aws_apigatewayv2_authorizer.cognito`):**
- Name: `tropico-cognito-authorizer-${var.environment}`
- `authorizer_type = "JWT"`
- `identity_sources = ["$request.header.Authorization"]`
- jwt_configuration:
  - audience = [aws_cognito_user_pool_client.admin.id]
  - issuer = "https://${aws_cognito_user_pool.admin.endpoint}"

**Update CORS** in `aws_apigatewayv2_api.leads`:
- Add "GET" to allow_methods (currently only POST, OPTIONS)
- Add admin dashboard origins to cors_origins local (admin.tropicoretreat.com if production, localhost for dev)

**Protected Route:**
Create a placeholder Lambda for GET /leads (or reuse existing if available):

1. Add `aws_apigatewayv2_route.get_leads`:
   - route_key = "GET /leads"
   - authorization_type = "JWT"
   - authorizer_id = aws_apigatewayv2_authorizer.cognito.id
   - target = placeholder integration (can use same Lambda for now, will replace in Phase 5)

For now, create a minimal integration that returns mock data. The actual GET /leads Lambda will be implemented in Phase 5 (Admin Dashboard).

Create `aws_apigatewayv2_integration.get_leads` pointing to create_lead Lambda temporarily (it will 405 but proves authorizer works).

This demonstrates the authorizer is working - 401 without token, then integation response with token.
  </action>
  <verify>
1. `cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/infra && terraform plan` shows authorizer and route to be created
2. No errors in plan output
  </verify>
  <done>
JWT authorizer configured referencing Cognito User Pool. GET /leads route uses JWT authorization_type with authorizer_id.
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy Cognito infrastructure and verify</name>
  <files>None (deployment only)</files>
  <action>
Deploy the Cognito infrastructure:

1. Run `cd /Users/juliantellez/github.com/atlantic-blue/tropicoretreats/infra && terraform apply -auto-approve`
2. Capture outputs: cognito_user_pool_id, cognito_user_pool_endpoint, cognito_client_id
3. Verify resources created:
   - `aws cognito-idp describe-user-pool --user-pool-id <pool_id>` confirms admin-only creation
   - GET /leads without token returns 401 Unauthorized

Test the authorizer rejects unauthenticated requests:
```bash
curl -v "https://u57cra1p8h.execute-api.us-east-1.amazonaws.com/leads"
# Should return 401 Unauthorized (no Authorization header)
```

Record the outputs for Phase 5 (Admin Dashboard) to use for Amplify configuration.
  </action>
  <verify>
1. terraform apply completes without errors
2. curl GET /leads returns 401 Unauthorized (authorizer working)
3. terraform output shows cognito_user_pool_id, cognito_client_id
  </verify>
  <done>
Cognito User Pool and JWT authorizer deployed. GET /leads returns 401 without valid token.
  </done>
</task>

</tasks>

<verification>
Phase 4 Plan 01 verification:

1. **Infrastructure exists:**
   - `aws cognito-idp describe-user-pool --user-pool-id $(terraform output -raw cognito_user_pool_id)` succeeds
   - `aws cognito-idp describe-user-pool-client --user-pool-id $(terraform output -raw cognito_user_pool_id) --client-id $(terraform output -raw cognito_client_id)` succeeds

2. **Authorizer rejects unauthenticated:**
   - `curl -s -o /dev/null -w "%{http_code}" "https://u57cra1p8h.execute-api.us-east-1.amazonaws.com/leads"` returns 401

3. **Configuration correct:**
   - User Pool has AdminCreateUserOnly enabled
   - App Client has no secret (generate_secret = false)
   - JWT authorizer references correct issuer and audience
</verification>

<success_criteria>
- Cognito User Pool deployed with admin-only user creation
- App Client deployed with no secret and SRP auth flows
- JWT authorizer attached to GET /leads route
- Unauthenticated requests to GET /leads return 401
- Terraform outputs expose User Pool ID, endpoint, and Client ID
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-auth/04-01-SUMMARY.md` following the summary template.

Include:
- Cognito User Pool ID and endpoint
- App Client ID
- API endpoint for GET /leads
- Verification results (401 response)
</output>
