---
phase: 03-notifications
plan: 04
type: execute
wave: 3
depends_on: ["03-03"]
files_modified: []
autonomous: false
user_setup:
  - service: ses
    why: "SES sandbox requires verified recipient emails"
    env_vars:
      - name: TEAM_EMAILS
        source: "Your team email addresses (must be verified in SES sandbox)"
    dashboard_config:
      - task: "Verify your email address in SES to receive test notifications"
        location: "AWS Console -> SES -> Verified identities -> Create identity -> Email address"
        notes: "Check your inbox and click the verification link from AWS"

must_haves:
  truths:
    - "Team receives email within 60 seconds of form submission"
    - "Customer receives auto-reply confirming their inquiry"
    - "Notification failures do not block lead storage"
  artifacts: []
  key_links:
    - from: "Contact form submission"
      to: "DynamoDB leads table"
      via: "POST /leads API"
      pattern: "201 Created"
    - from: "DynamoDB INSERT event"
      to: "Notification Lambda"
      via: "DynamoDB Streams"
      pattern: "CloudWatch logs show processing"
    - from: "Notification Lambda"
      to: "SES"
      via: "sendEmail calls"
      pattern: "Email delivered"
---

<objective>
Verify end-to-end notification flow works correctly.

Purpose: Confirm that submitting the contact form triggers both team notification and customer auto-reply emails within 60 seconds, and that the decoupled architecture doesn't block the API response.

Output: Verified notification system ready for production, documented test results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-notifications/03-CONTEXT.md
@.planning/phases/03-notifications/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure team email and verify SES setup</name>
  <files></files>
  <action>
1. Check current SES DKIM status:
```bash
aws sesv2 get-email-identity --email-identity tropicoretreat.com --query 'DkimAttributes.Status'
```
If not "SUCCESS", DKIM is still propagating. The emails may still work but without DKIM signing.

2. In SES sandbox mode, ALL recipient addresses must be verified. Check if any emails are verified:
```bash
aws ses list-identities --identity-type EmailAddress
```

3. If no emails are verified (or user's email is not in the list), provide instructions:

The user needs to verify their email address in SES:
- Go to AWS Console -> Amazon SES -> Verified identities
- Click "Create identity" -> Select "Email address"
- Enter your email address
- Check your inbox and click the verification link

4. Update the Lambda environment variable with verified team email:
```bash
# Get current env vars
aws lambda get-function-configuration --function-name tropico-notifications-dev --query 'Environment.Variables'

# Update with verified team email (replace with actual verified email)
aws lambda update-function-configuration \
  --function-name tropico-notifications-dev \
  --environment "Variables={ENVIRONMENT=dev,TEAM_EMAILS=YOUR_VERIFIED_EMAIL,FROM_EMAIL_TEAM=leads@tropicoretreat.com,FROM_EMAIL_CUSTOMER=hello@tropicoretreat.com,FROM_NAME=Tropico Retreats}"
```

Note: In SES sandbox, the "from" addresses (leads@, hello@) also need to work. Since we verified the domain (tropicoretreat.com), domain-based identities should work even in sandbox.
  </action>
  <verify>
```bash
# Verify Lambda has TEAM_EMAILS configured
aws lambda get-function-configuration --function-name tropico-notifications-dev --query 'Environment.Variables.TEAM_EMAILS'
```
Should return a non-empty email address.
  </verify>
  <done>
Team email configured in Lambda environment and verified in SES sandbox.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test end-to-end notification flow</name>
  <files></files>
  <action>
1. Get the API endpoint:
```bash
cd infra && terraform output api_endpoint
```

2. Submit a test lead via curl and measure time:
```bash
API_URL=$(cd infra && terraform output -raw api_endpoint)

time curl -X POST "${API_URL}/leads" \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "Test",
    "lastName": "Notification",
    "email": "YOUR_VERIFIED_EMAIL_HERE",
    "phone": "+44123456789",
    "company": "Test Company Ltd",
    "destination": "Caribbean",
    "groupSize": "10-15",
    "message": "This is a test submission to verify the notification system works correctly."
  }'
```

Note the response time - should be fast (< 2 seconds) since notifications are decoupled.

3. Check Lambda logs for processing (wait ~30 seconds):
```bash
aws logs tail /aws/lambda/tropico-notifications-dev --since 5m
```

Look for:
- "Processing X stream record(s)"
- "Processing lead: XXXXXXX"
- "Team notification sent to X recipient(s)"
- "Customer auto-reply sent to YOUR_EMAIL"

4. Check inbox for both emails:
- Team notification with subject "New Lead from Test Company Ltd"
- Customer auto-reply with subject "Your Caribbean Retreat Enquiry"

5. Verify timing (from lead createdAt to email received should be < 60 seconds)
  </action>
  <verify>
Success criteria:
- API returns 201 in < 2 seconds (decoupled)
- Lambda logs show successful processing
- Team notification email received with all lead details
- Customer auto-reply received with reference number (TR-2026-XXXXXX)
- Total time from submission to email receipt < 60 seconds
  </verify>
  <done>
Test lead submitted, both emails received within 60 seconds, Lambda logs show successful processing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete notification system with:
- DynamoDB Streams triggering notification Lambda on new leads
- Team notification email with all lead details, London timezone, reply-to customer
- Customer auto-reply with reference number, 48-hour promise, submission confirmation
- Decoupled architecture that doesn't block API response
- SQS Dead Letter Queue for failed notifications
  </what-built>
  <how-to-verify>
1. Check your email inbox for both notification emails:
   - Team notification: Look for "New Lead from Test Company Ltd" (or customer name)
   - Customer auto-reply: Look for "Your Caribbean Retreat Enquiry"

2. Verify Team Notification email content:
   - All lead fields present (name, email, phone, company, destination, group size, message)
   - Timestamp in London timezone (e.g., "Thursday, 23 January 2026 at 14:30")
   - Reply-to is set to the customer's email
   - Tropico Retreats branding and logo

3. Verify Customer Auto-Reply email content:
   - Reference number in format TR-2026-XXXXXX
   - 48-hour response promise mentioned
   - Full submission details echoed back
   - WhatsApp mention for faster response
   - Instagram and LinkedIn links in footer
   - Warm, personal tone

4. Verify timing:
   - API response was fast (< 2 seconds)
   - Emails arrived within 60 seconds of submission

5. (Optional) Test failure handling:
   - Check DLQ is empty (no failures):
     ```bash
     aws sqs get-queue-attributes \
       --queue-url $(aws sqs get-queue-url --queue-name tropico-notifications-dlq-dev --query QueueUrl --output text) \
       --attribute-names ApproximateNumberOfMessages
     ```
  </how-to-verify>
  <resume-signal>
Reply with one of:
- "approved" - Emails look correct, all criteria met
- "issues: [describe problems]" - If emails missing, content wrong, or timing too slow
  </resume-signal>
</task>

</tasks>

<verification>
Overall Phase 3 verification:

1. SES domain verified:
```bash
aws sesv2 get-email-identity --email-identity tropicoretreat.com --query 'VerificationStatus'
```

2. DynamoDB Streams enabled:
```bash
aws dynamodb describe-table --table-name tropico-leads-dev --query 'Table.StreamSpecification.StreamEnabled'
```

3. Notification Lambda triggered on new leads:
```bash
aws logs filter-log-events \
  --log-group-name /aws/lambda/tropico-notifications-dev \
  --filter-pattern "Processing lead" \
  --start-time $(date -d '1 hour ago' +%s000)
```

4. Emails sent successfully (no errors in logs):
```bash
aws logs filter-log-events \
  --log-group-name /aws/lambda/tropico-notifications-dev \
  --filter-pattern "ERROR" \
  --start-time $(date -d '1 hour ago' +%s000)
```
Should return empty (no errors).

5. DLQ is empty (no failed notifications):
```bash
aws sqs get-queue-attributes \
  --queue-url $(aws sqs get-queue-url --queue-name tropico-notifications-dlq-dev --query QueueUrl --output text) \
  --attribute-names ApproximateNumberOfMessages
```
Should show 0 messages.
</verification>

<success_criteria>
From ROADMAP.md Phase 3 Success Criteria:

1. Team receives email within 60 seconds of form submission - VERIFIED
2. Email contains lead name, email, phone, message, and timestamp - VERIFIED
3. Customer receives auto-reply confirming their inquiry was received - VERIFIED
4. Auto-reply includes expected response timeframe (48 hours) - VERIFIED
5. Notification failures do not block lead storage (async/decoupled) - VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/03-notifications/03-04-SUMMARY.md`
</output>
