---
phase: 03-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/handlers/processLeadNotifications.ts
  - backend/src/lib/ses.ts
  - backend/src/templates/teamNotification.ts
  - backend/src/templates/customerAutoReply.ts
  - backend/src/utils/referenceNumber.ts
  - backend/src/utils/formatTime.ts
  - backend/esbuild.config.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Notification Lambda handler processes DynamoDB stream INSERT events"
    - "Team notification email includes all lead details in London timezone"
    - "Customer auto-reply includes reference number and 48-hour promise"
    - "Both emails use HTML templates with inline CSS"
  artifacts:
    - path: "backend/src/handlers/processLeadNotifications.ts"
      provides: "DynamoDB stream handler that sends both emails"
      exports: ["handler"]
    - path: "backend/src/lib/ses.ts"
      provides: "SES client singleton and sendEmail function"
      exports: ["sendEmail"]
    - path: "backend/src/templates/teamNotification.ts"
      provides: "HTML template for team notification email"
      exports: ["teamNotificationTemplate"]
    - path: "backend/src/templates/customerAutoReply.ts"
      provides: "HTML template for customer auto-reply"
      exports: ["customerAutoReplyTemplate"]
  key_links:
    - from: "backend/src/handlers/processLeadNotifications.ts"
      to: "backend/src/lib/ses.ts"
      via: "import sendEmail"
      pattern: "import.*sendEmail.*from.*ses"
    - from: "backend/src/handlers/processLeadNotifications.ts"
      to: "@aws-sdk/util-dynamodb"
      via: "unmarshall DynamoDB stream records"
      pattern: "unmarshall"
---

<objective>
Create Lambda handler and email templates for processing lead notifications.

Purpose: When a new lead is inserted into DynamoDB, this Lambda will send a team notification email and a customer auto-reply email via SES.

Output: Notification Lambda code with HTML email templates, ready for infrastructure deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-notifications/03-CONTEXT.md
@.planning/phases/03-notifications/03-RESEARCH.md
@.planning/phases/01-core-api/01-01-SUMMARY.md

# Existing patterns
@backend/src/handlers/createLead.ts
@backend/src/lib/dynamodb.ts
@backend/src/lib/types.ts
@backend/esbuild.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SES client and utility functions</name>
  <files>backend/src/lib/ses.ts, backend/src/utils/referenceNumber.ts, backend/src/utils/formatTime.ts</files>
  <action>
1. Create `backend/src/lib/ses.ts` - SES client singleton following dynamodb.ts pattern:

```typescript
import { SESClient, SendEmailCommand } from '@aws-sdk/client-ses';

// Initialize SES client outside handler for warm start reuse
const sesClient = new SESClient({});

export interface EmailParams {
  to: string[];
  from: string;
  replyTo: string;
  subject: string;
  htmlBody: string;
  textBody: string;
}

/**
 * Send email via SES
 * @throws Error if SES send fails
 */
export const sendEmail = async (params: EmailParams): Promise<void> => {
  await sesClient.send(
    new SendEmailCommand({
      Source: params.from,
      Destination: { ToAddresses: params.to },
      ReplyToAddresses: [params.replyTo],
      Message: {
        Subject: { Data: params.subject, Charset: 'UTF-8' },
        Body: {
          Html: { Data: params.htmlBody, Charset: 'UTF-8' },
          Text: { Data: params.textBody, Charset: 'UTF-8' },
        },
      },
    })
  );
};
```

2. Create `backend/src/utils/referenceNumber.ts`:

```typescript
import crypto from 'crypto';

/**
 * Generate unique reference number in format TR-YYYY-XXXXXX
 * Example: TR-2026-A3F7B2
 */
export const generateReferenceNumber = (): string => {
  const year = new Date().getFullYear();
  const randomPart = crypto.randomBytes(3).toString('hex').toUpperCase();
  return `TR-${year}-${randomPart}`;
};
```

3. Create `backend/src/utils/formatTime.ts`:

```typescript
/**
 * Format ISO timestamp to London timezone for emails
 * Example output: "Thursday, 23 January 2026 at 14:30"
 */
export const formatLondonTime = (isoString: string): string => {
  const date = new Date(isoString);
  return new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Europe/London',
    dateStyle: 'full',
    timeStyle: 'short',
  }).format(date);
};
```
  </action>
  <verify>
```bash
cd backend && npx tsc --noEmit
```
TypeScript compilation should pass with no errors.
  </verify>
  <done>
SES client singleton, reference number generator, and London timezone formatter created and type-check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HTML email templates</name>
  <files>backend/src/templates/teamNotification.ts, backend/src/templates/customerAutoReply.ts</files>
  <action>
Create `backend/src/templates/` directory and add both templates.

1. Create `backend/src/templates/teamNotification.ts`:

```typescript
import type { Lead } from '../lib/types.js';
import { formatLondonTime } from '../utils/formatTime.js';

interface TeamNotificationResult {
  html: string;
  text: string;
  subject: string;
}

/**
 * Generate team notification email content
 * Per CONTEXT.md: All lead info weighted equally, Reply-to customer email
 */
export const teamNotificationTemplate = (lead: Lead): TeamNotificationResult => {
  const timestamp = formatLondonTime(lead.createdAt);
  const subjectName = lead.company || `${lead.firstName} ${lead.lastName}`;

  const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; background-color: #f4f4f4;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff;">
    <tr>
      <td style="padding: 20px; text-align: center; background-color: #1a365d;">
        <img src="https://tropicoretreat.com/public/favicon.jpg" alt="Tropico Retreats" width="50" height="50" style="display: inline-block;">
        <h1 style="color: #ffffff; font-size: 20px; margin: 10px 0 0 0;">New Lead Received</h1>
      </td>
    </tr>
    <tr>
      <td style="padding: 30px 20px;">
        <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="border: 1px solid #e2e8f0; border-radius: 8px;">
          <tr>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Name</strong>
            </td>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
              ${lead.firstName} ${lead.lastName}
            </td>
          </tr>
          <tr>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Email</strong>
            </td>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
              <a href="mailto:${lead.email}" style="color: #2b6cb0;">${lead.email}</a>
            </td>
          </tr>
          ${lead.phone ? `<tr>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Phone</strong>
            </td>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
              <a href="tel:${lead.phone}" style="color: #2b6cb0;">${lead.phone}</a>
            </td>
          </tr>` : ''}
          ${lead.company ? `<tr>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Company</strong>
            </td>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
              ${lead.company}
            </td>
          </tr>` : ''}
          ${lead.destination ? `<tr>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Destination</strong>
            </td>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
              ${lead.destination}
            </td>
          </tr>` : ''}
          ${lead.groupSize ? `<tr>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Group Size</strong>
            </td>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
              ${lead.groupSize}
            </td>
          </tr>` : ''}
          ${lead.preferredDates ? `<tr>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Preferred Dates</strong>
            </td>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
              ${lead.preferredDates}
            </td>
          </tr>` : ''}
          <tr>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Message</strong>
            </td>
            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0;">
              ${lead.message.replace(/\n/g, '<br>')}
            </td>
          </tr>
          <tr>
            <td style="padding: 15px; background-color: #f7fafc;">
              <strong style="color: #4a5568;">Received</strong>
            </td>
            <td style="padding: 15px;">
              ${timestamp}
            </td>
          </tr>
        </table>
        <p style="margin-top: 20px; color: #718096; font-size: 14px;">
          Reply directly to this email to respond to the customer.
        </p>
      </td>
    </tr>
    <tr>
      <td style="padding: 20px; text-align: center; background-color: #f7fafc; color: #718096; font-size: 12px;">
        <p style="margin: 0;">Tropico Retreats Lead Management</p>
        <p style="margin: 5px 0 0 0;">London, United Kingdom</p>
        <p style="margin: 5px 0 0 0;">&copy; ${new Date().getFullYear()} Tropico Retreats</p>
      </td>
    </tr>
  </table>
</body>
</html>`;

  const text = `New Lead Received

Name: ${lead.firstName} ${lead.lastName}
Email: ${lead.email}
${lead.phone ? `Phone: ${lead.phone}\n` : ''}${lead.company ? `Company: ${lead.company}\n` : ''}${lead.destination ? `Destination: ${lead.destination}\n` : ''}${lead.groupSize ? `Group Size: ${lead.groupSize}\n` : ''}${lead.preferredDates ? `Preferred Dates: ${lead.preferredDates}\n` : ''}
Message:
${lead.message}

Received: ${timestamp}

Reply to this email to respond to the customer.

---
Tropico Retreats Lead Management
London, United Kingdom`;

  return {
    html,
    text,
    subject: `New Lead from ${subjectName}`,
  };
};
```

2. Create `backend/src/templates/customerAutoReply.ts`:

```typescript
import type { Lead } from '../lib/types.js';
import { formatLondonTime } from '../utils/formatTime.js';

interface CustomerAutoReplyResult {
  html: string;
  text: string;
  subject: string;
}

/**
 * Generate customer auto-reply email content
 * Per CONTEXT.md: Warm & personal, 48-hour promise, reference number, WhatsApp option
 */
export const customerAutoReplyTemplate = (
  lead: Lead,
  referenceNumber: string
): CustomerAutoReplyResult => {
  const timestamp = formatLondonTime(lead.createdAt);
  const destinationText = lead.destination
    ? `Your ${lead.destination} Retreat Enquiry`
    : 'Your Tropico Retreats Enquiry';

  const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; background-color: #f4f4f4;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="max-width: 600px; margin: 0 auto; background-color: #ffffff;">
    <tr>
      <td style="padding: 20px; text-align: center; background-color: #1a365d;">
        <img src="https://tropicoretreat.com/public/favicon.jpg" alt="Tropico Retreats" width="50" height="50" style="display: inline-block;">
      </td>
    </tr>
    <tr>
      <td style="padding: 30px 20px;">
        <h1 style="color: #1a365d; font-size: 24px; margin: 0 0 20px 0;">Thank you for your enquiry!</h1>

        <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
          Hi ${lead.firstName},
        </p>

        <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
          Thank you for reaching out to Tropico Retreats! We're excited to hear about your interest in creating an unforgettable retreat experience.
        </p>

        <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
          <strong>Your reference number is: <span style="color: #2b6cb0;">${referenceNumber}</span></strong><br>
          Please keep this handy if you need to contact us about your enquiry.
        </p>

        <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
          Our team will personally review your request and get back to you <strong>within 48 hours</strong> with tailored recommendations for your retreat.
        </p>

        <div style="background-color: #f7fafc; border-radius: 8px; padding: 20px; margin: 20px 0;">
          <h3 style="color: #1a365d; font-size: 16px; margin: 0 0 15px 0;">What you submitted:</h3>
          <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
            <tr>
              <td style="padding: 5px 0; color: #718096; width: 120px;">Name:</td>
              <td style="padding: 5px 0; color: #4a5568;">${lead.firstName} ${lead.lastName}</td>
            </tr>
            <tr>
              <td style="padding: 5px 0; color: #718096;">Email:</td>
              <td style="padding: 5px 0; color: #4a5568;">${lead.email}</td>
            </tr>
            ${lead.phone ? `<tr>
              <td style="padding: 5px 0; color: #718096;">Phone:</td>
              <td style="padding: 5px 0; color: #4a5568;">${lead.phone}</td>
            </tr>` : ''}
            ${lead.company ? `<tr>
              <td style="padding: 5px 0; color: #718096;">Company:</td>
              <td style="padding: 5px 0; color: #4a5568;">${lead.company}</td>
            </tr>` : ''}
            ${lead.destination ? `<tr>
              <td style="padding: 5px 0; color: #718096;">Destination:</td>
              <td style="padding: 5px 0; color: #4a5568;">${lead.destination}</td>
            </tr>` : ''}
            ${lead.groupSize ? `<tr>
              <td style="padding: 5px 0; color: #718096;">Group Size:</td>
              <td style="padding: 5px 0; color: #4a5568;">${lead.groupSize}</td>
            </tr>` : ''}
            ${lead.preferredDates ? `<tr>
              <td style="padding: 5px 0; color: #718096;">Preferred Dates:</td>
              <td style="padding: 5px 0; color: #4a5568;">${lead.preferredDates}</td>
            </tr>` : ''}
            <tr>
              <td style="padding: 5px 0; color: #718096; vertical-align: top;">Message:</td>
              <td style="padding: 5px 0; color: #4a5568;">${lead.message.replace(/\n/g, '<br>')}</td>
            </tr>
            <tr>
              <td style="padding: 5px 0; color: #718096;">Submitted:</td>
              <td style="padding: 5px 0; color: #4a5568;">${timestamp}</td>
            </tr>
          </table>
        </div>

        <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 20px 0;">
          <strong>Need a faster response?</strong><br>
          Feel free to reach us on WhatsApp for immediate assistance.
        </p>

        <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 20px 0 0 0;">
          Warm regards,<br>
          <strong>The Tropico Retreats Team</strong>
        </p>
      </td>
    </tr>
    <tr>
      <td style="padding: 20px; text-align: center; background-color: #f7fafc;">
        <p style="margin: 0 0 10px 0;">
          <a href="https://instagram.com/tropicoretreat" style="color: #2b6cb0; text-decoration: none; margin: 0 10px;">Instagram</a>
          <a href="https://linkedin.com/company/tropicoretreat" style="color: #2b6cb0; text-decoration: none; margin: 0 10px;">LinkedIn</a>
        </p>
        <p style="margin: 0; color: #718096; font-size: 12px;">
          Tropico Retreats | London, United Kingdom
        </p>
        <p style="margin: 5px 0 0 0; color: #718096; font-size: 12px;">
          &copy; ${new Date().getFullYear()} Tropico Retreats. All rights reserved.
        </p>
      </td>
    </tr>
  </table>
</body>
</html>`;

  const text = `Thank you for your enquiry!

Hi ${lead.firstName},

Thank you for reaching out to Tropico Retreats! We're excited to hear about your interest in creating an unforgettable retreat experience.

Your reference number is: ${referenceNumber}
Please keep this handy if you need to contact us about your enquiry.

Our team will personally review your request and get back to you within 48 hours with tailored recommendations for your retreat.

What you submitted:
- Name: ${lead.firstName} ${lead.lastName}
- Email: ${lead.email}
${lead.phone ? `- Phone: ${lead.phone}\n` : ''}${lead.company ? `- Company: ${lead.company}\n` : ''}${lead.destination ? `- Destination: ${lead.destination}\n` : ''}${lead.groupSize ? `- Group Size: ${lead.groupSize}\n` : ''}${lead.preferredDates ? `- Preferred Dates: ${lead.preferredDates}\n` : ''}- Message: ${lead.message}
- Submitted: ${timestamp}

Need a faster response?
Feel free to reach us on WhatsApp for immediate assistance.

Warm regards,
The Tropico Retreats Team

---
Instagram: https://instagram.com/tropicoretreat
LinkedIn: https://linkedin.com/company/tropicoretreat

Tropico Retreats | London, United Kingdom
(c) ${new Date().getFullYear()} Tropico Retreats`;

  return {
    html,
    text,
    subject: destinationText,
  };
};
```

Both templates follow HTML email best practices from RESEARCH.md:
- Table-based layouts (no flexbox/grid)
- Inline CSS only (no style tags)
- Web-safe fonts (Arial, Helvetica)
- Plain text alternative included
  </action>
  <verify>
```bash
cd backend && npx tsc --noEmit
```
TypeScript should compile without errors.
  </verify>
  <done>
Both email templates created with inline CSS, table layouts, and plain text alternatives.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create notification Lambda handler and update build</name>
  <files>backend/src/handlers/processLeadNotifications.ts, backend/esbuild.config.js</files>
  <action>
1. Create `backend/src/handlers/processLeadNotifications.ts`:

```typescript
import type { DynamoDBStreamEvent } from 'aws-lambda';
import { unmarshall } from '@aws-sdk/util-dynamodb';
import type { AttributeValue } from '@aws-sdk/client-dynamodb';

import type { Lead } from '../lib/types.js';
import { sendEmail } from '../lib/ses.js';
import { teamNotificationTemplate } from '../templates/teamNotification.js';
import { customerAutoReplyTemplate } from '../templates/customerAutoReply.js';
import { generateReferenceNumber } from '../utils/referenceNumber.js';

// Environment variables
const TEAM_EMAILS = process.env.TEAM_EMAILS?.split(',') ?? [];
const FROM_EMAIL_TEAM = process.env.FROM_EMAIL_TEAM ?? 'leads@tropicoretreat.com';
const FROM_EMAIL_CUSTOMER = process.env.FROM_EMAIL_CUSTOMER ?? 'hello@tropicoretreat.com';
const FROM_NAME = process.env.FROM_NAME ?? 'Tropico Retreats';

/**
 * Process DynamoDB stream events for new leads
 * Sends team notification and customer auto-reply emails
 *
 * Triggered by DynamoDB Streams on INSERT events only (filtered at event source mapping)
 */
export const handler = async (event: DynamoDBStreamEvent): Promise<void> => {
  console.log(`Processing ${event.Records.length} stream record(s)`);

  for (const record of event.Records) {
    // Only process INSERT events (new leads)
    // Note: Event source mapping filters to INSERT only, but double-check here
    if (record.eventName !== 'INSERT') {
      console.log(`Skipping ${record.eventName} event`);
      continue;
    }

    const newImage = record.dynamodb?.NewImage;
    if (!newImage) {
      console.error('No NewImage in stream record');
      continue;
    }

    // Unmarshall DynamoDB record to Lead object
    const lead = unmarshall(
      newImage as Record<string, AttributeValue>
    ) as Lead;

    console.log(`Processing lead: ${lead.id} (${lead.email})`);

    // Generate reference number for customer
    const referenceNumber = generateReferenceNumber();

    try {
      // Send team notification email
      if (TEAM_EMAILS.length > 0) {
        const teamEmail = teamNotificationTemplate(lead);
        await sendEmail({
          to: TEAM_EMAILS,
          from: `${FROM_NAME} <${FROM_EMAIL_TEAM}>`,
          replyTo: lead.email,
          subject: teamEmail.subject,
          htmlBody: teamEmail.html,
          textBody: teamEmail.text,
        });
        console.log(`Team notification sent to ${TEAM_EMAILS.length} recipient(s)`);
      } else {
        console.warn('No TEAM_EMAILS configured, skipping team notification');
      }

      // Send customer auto-reply email
      const customerEmail = customerAutoReplyTemplate(lead, referenceNumber);
      await sendEmail({
        to: [lead.email],
        from: `${FROM_NAME} <${FROM_EMAIL_CUSTOMER}>`,
        replyTo: 'hello@tropicoretreat.com',
        subject: customerEmail.subject,
        htmlBody: customerEmail.html,
        textBody: customerEmail.text,
      });
      console.log(`Customer auto-reply sent to ${lead.email} (ref: ${referenceNumber})`);

    } catch (error) {
      // Log error but don't rethrow - let DLQ handle failures
      // Per RESEARCH.md: Maximum 3 retries configured at event source mapping
      console.error(`Failed to send emails for lead ${lead.id}:`, error);
      throw error; // Rethrow to trigger retry/DLQ
    }
  }

  console.log('Stream processing complete');
};
```

2. Update `backend/esbuild.config.js` to build multiple entry points:

```javascript
import * as esbuild from 'esbuild';

await esbuild.build({
  entryPoints: [
    'src/handlers/createLead.ts',
    'src/handlers/processLeadNotifications.ts',
  ],
  bundle: true,
  minify: true,
  sourcemap: true,
  platform: 'node',
  target: 'node22',
  outdir: 'dist',
  format: 'esm',
  external: ['@aws-sdk/*'],
  banner: {
    js: "import { createRequire } from 'module'; const require = createRequire(import.meta.url);",
  },
  outExtension: { '.js': '.mjs' },
});

console.log('Build complete: dist/createLead.mjs, dist/processLeadNotifications.mjs');
```

Note the changes from original:
- `entryPoints` is now an array with both handlers
- Changed `outfile` to `outdir: 'dist'`
- Added `outExtension: { '.js': '.mjs' }` to maintain .mjs extension for ESM
- Output files will be named after entry point (createLead.mjs, processLeadNotifications.mjs)
  </action>
  <verify>
```bash
cd backend && npm run build && ls -la dist/
```
Should show:
- createLead.mjs
- createLead.mjs.map
- processLeadNotifications.mjs
- processLeadNotifications.mjs.map
  </verify>
  <done>
Notification Lambda handler created, esbuild updated for multiple entry points, both handlers build successfully.
  </done>
</task>

</tasks>

<verification>
Overall phase 03-02 verification:

1. TypeScript compiles:
```bash
cd backend && npx tsc --noEmit
```

2. Both Lambda handlers build:
```bash
cd backend && npm run build
ls dist/*.mjs
```
Should list: createLead.mjs, processLeadNotifications.mjs

3. Handler exports are correct:
```bash
grep -l "export const handler" backend/src/handlers/*.ts
```
Should list both handler files.
</verification>

<success_criteria>
1. SES client singleton follows dynamodb.ts pattern (client outside handler)
2. teamNotificationTemplate exports HTML/text/subject with all lead fields
3. customerAutoReplyTemplate includes reference number and 48-hour promise
4. processLeadNotifications.ts handler unmarshalls DynamoDB records correctly
5. esbuild produces both createLead.mjs and processLeadNotifications.mjs
6. All code type-checks with `tsc --noEmit`
</success_criteria>

<output>
After completion, create `.planning/phases/03-notifications/03-02-SUMMARY.md`
</output>
