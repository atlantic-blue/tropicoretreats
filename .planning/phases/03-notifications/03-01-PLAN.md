---
phase: 03-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/api/ses.tf
  - infra/route53.tf
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SES domain identity exists for tropicoretreat.com"
    - "DKIM DNS records are created in Route53"
    - "SES can send emails from leads@tropicoretreat.com and hello@tropicoretreat.com"
  artifacts:
    - path: "infra/api/ses.tf"
      provides: "SES domain identity with DKIM configuration"
      contains: "aws_sesv2_email_identity"
  key_links:
    - from: "infra/api/ses.tf"
      to: "infra/route53.tf"
      via: "DKIM CNAME records using Route53 zone"
      pattern: "aws_route53_zone\\.www\\.id"
---

<objective>
Configure AWS SES for sending transactional emails from tropicoretreat.com domain.

Purpose: Enable the notification system to send branded emails from verified domain addresses (leads@tropicoretreat.com for team notifications, hello@tropicoretreat.com for customer auto-replies).

Output: SES domain identity verified with DKIM records in Route53.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-notifications/03-CONTEXT.md
@.planning/phases/03-notifications/03-RESEARCH.md
@.planning/phases/01-core-api/01-02-SUMMARY.md

# Existing infrastructure patterns
@infra/_locals.tf
@infra/route53.tf
@infra/api/variables.tf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SES domain identity with DKIM</name>
  <files>infra/api/ses.tf</files>
  <action>
Create new file `infra/api/ses.tf` with:

1. SES v2 email identity for tropicoretreat.com domain:
```hcl
resource "aws_sesv2_email_identity" "main" {
  email_identity = local.domain_name  # tropicoretreat.com from _locals.tf

  tags = local.tags
}
```

2. Route53 DKIM CNAME records (3 records required for DKIM):
```hcl
resource "aws_route53_record" "ses_dkim" {
  count   = 3
  zone_id = data.aws_route53_zone.www.id
  name    = "${aws_sesv2_email_identity.main.dkim_signing_attributes[0].tokens[count.index]}._domainkey.${local.domain_name}"
  type    = "CNAME"
  ttl     = 600
  records = ["${aws_sesv2_email_identity.main.dkim_signing_attributes[0].tokens[count.index]}.dkim.amazonses.com"]
}
```

Note: The api module needs access to the Route53 zone. Add a data source to look up the zone:
```hcl
data "aws_route53_zone" "www" {
  name = local.domain_name
}
```

Follow existing patterns:
- Use `local.domain_name` (tropicoretreat.com) from existing _locals.tf
- Use `local.tags` for resource tagging
- DKIM requires exactly 3 CNAME records with the token values from SES
  </action>
  <verify>
Run `terraform plan` from infra directory - should show:
- 1 aws_sesv2_email_identity to create
- 3 aws_route53_record (DKIM CNAMEs) to create
- 1 data.aws_route53_zone to read
  </verify>
  <done>
Terraform plan shows SES domain identity and 3 DKIM records will be created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy SES infrastructure and verify DKIM</name>
  <files>infra/api/ses.tf</files>
  <action>
1. Apply the Terraform changes:
```bash
cd infra && terraform apply -auto-approve
```

2. Verify SES domain identity was created:
```bash
aws ses get-identity-verification-attributes --identities tropicoretreat.com
```

3. Check DKIM status (may take a few minutes to propagate):
```bash
aws sesv2 get-email-identity --email-identity tropicoretreat.com --query 'DkimAttributes.Status'
```

Expected output: "SUCCESS" or "PENDING" (PENDING is acceptable, will become SUCCESS after DNS propagation)

4. Verify DNS records were created:
```bash
dig +short $(aws sesv2 get-email-identity --email-identity tropicoretreat.com --query 'DkimAttributes.Tokens[0]' --output text)._domainkey.tropicoretreat.com CNAME
```

Note: DKIM verification can take up to 72 hours but typically completes within minutes. The system will work once status becomes "SUCCESS".
  </action>
  <verify>
- `terraform apply` completes without errors
- `aws sesv2 get-email-identity --email-identity tropicoretreat.com` returns identity details
- DKIM status is either "SUCCESS" or "PENDING"
  </verify>
  <done>
SES domain identity is created and DKIM DNS records are in Route53. DKIM status is SUCCESS or PENDING (verification in progress).
  </done>
</task>

</tasks>

<verification>
Overall phase 03-01 verification:

1. SES domain identity exists:
```bash
aws sesv2 get-email-identity --email-identity tropicoretreat.com
```

2. DKIM records exist in Route53 (check AWS console or dig):
```bash
dig +short *._domainkey.tropicoretreat.com CNAME | head -1
```

3. Terraform state includes the SES resources:
```bash
cd infra && terraform state list | grep ses
```
</verification>

<success_criteria>
1. aws_sesv2_email_identity.main resource exists in Terraform state
2. 3 DKIM CNAME records created in Route53 zone
3. SES identity shows in AWS console for tropicoretreat.com
4. DKIM status is SUCCESS or PENDING (both acceptable for Phase 3 completion)
</success_criteria>

<output>
After completion, create `.planning/phases/03-notifications/03-01-SUMMARY.md`
</output>
