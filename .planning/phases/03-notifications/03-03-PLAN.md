---
phase: 03-notifications
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - infra/api/dynamodb.tf
  - infra/api/lambda.tf
  - infra/api/iam.tf
  - infra/api/notifications.tf
  - infra/api/variables.tf
autonomous: true
user_setup:
  - service: ses
    why: "SES sandbox requires verified recipient emails for dev testing"
    env_vars: []
    dashboard_config:
      - task: "Verify team email addresses in SES sandbox"
        location: "AWS Console -> SES -> Verified identities -> Create identity -> Email address"
        notes: "Each team member must click verification link. Required for dev environment only."

must_haves:
  truths:
    - "DynamoDB Streams is enabled on leads table"
    - "Notification Lambda is triggered by stream INSERT events"
    - "Failed notifications go to SQS Dead Letter Queue"
    - "Notification Lambda can send emails via SES"
  artifacts:
    - path: "infra/api/dynamodb.tf"
      provides: "DynamoDB table with streams enabled"
      contains: "stream_enabled = true"
    - path: "infra/api/notifications.tf"
      provides: "Notification Lambda, event source mapping, DLQ"
      contains: "aws_lambda_event_source_mapping"
    - path: "infra/api/iam.tf"
      provides: "IAM policies for SES and streams"
      contains: "ses:SendEmail"
  key_links:
    - from: "infra/api/notifications.tf"
      to: "infra/api/dynamodb.tf"
      via: "event_source_arn = aws_dynamodb_table.leads.stream_arn"
      pattern: "aws_dynamodb_table\\.leads\\.stream_arn"
    - from: "infra/api/notifications.tf"
      to: "infra/api/ses.tf"
      via: "Lambda env var FROM_EMAIL references verified domain"
      pattern: "FROM_EMAIL"
---

<objective>
Deploy notification Lambda infrastructure with DynamoDB Streams trigger and failure handling.

Purpose: Complete the decoupled notification architecture where new leads automatically trigger email notifications without blocking the API response.

Output: Notification Lambda deployed, DynamoDB Streams enabled, SQS DLQ configured, IAM permissions in place.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-notifications/03-CONTEXT.md
@.planning/phases/03-notifications/03-RESEARCH.md
@.planning/phases/03-notifications/03-01-SUMMARY.md
@.planning/phases/03-notifications/03-02-SUMMARY.md

# Existing infrastructure
@infra/api/dynamodb.tf
@infra/api/lambda.tf
@infra/api/iam.tf
@infra/api/variables.tf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable DynamoDB Streams and add notification variables</name>
  <files>infra/api/dynamodb.tf, infra/api/variables.tf</files>
  <action>
1. Update `infra/api/dynamodb.tf` to enable streams:

Add these lines to the existing aws_dynamodb_table.leads resource:

```hcl
resource "aws_dynamodb_table" "leads" {
  # ... existing configuration ...

  # Enable streams for notification trigger
  stream_enabled   = true
  stream_view_type = "NEW_IMAGE"  # Only need new data for notifications

  # ... rest of existing config ...
}
```

2. Update `infra/api/variables.tf` to add notification configuration:

```hcl
# Add these new variables after existing ones

variable "team_emails" {
  description = "Comma-separated list of team email addresses for notifications"
  type        = string
  default     = ""
}

variable "from_email_team" {
  description = "From email address for team notifications"
  type        = string
  default     = "leads@tropicoretreat.com"
}

variable "from_email_customer" {
  description = "From email address for customer auto-replies"
  type        = string
  default     = "hello@tropicoretreat.com"
}

variable "from_name" {
  description = "From name for all emails"
  type        = string
  default     = "Tropico Retreats"
}
```
  </action>
  <verify>
```bash
cd infra && terraform validate
```
Should pass with no errors.
  </verify>
  <done>
DynamoDB streams enabled with NEW_IMAGE view type, notification variables added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notification Lambda and DLQ infrastructure</name>
  <files>infra/api/notifications.tf, infra/api/lambda.tf</files>
  <action>
1. Update `infra/api/lambda.tf` to fix the archive_file for multiple handlers:

The existing archive_file bundles a single file. We need to update it to use the new output structure:

```hcl
# Replace the existing archive_file with one for createLead
data "archive_file" "create_lead_lambda" {
  type        = "zip"
  source_file = "${path.module}/../../backend/dist/createLead.mjs"
  output_path = "${path.module}/../../backend/dist/createLead.zip"
}

# Add archive for notifications Lambda
data "archive_file" "notifications_lambda" {
  type        = "zip"
  source_file = "${path.module}/../../backend/dist/processLeadNotifications.mjs"
  output_path = "${path.module}/../../backend/dist/notifications.zip"
}
```

Update the existing aws_lambda_function.create_lead to use the new archive:

```hcl
resource "aws_lambda_function" "create_lead" {
  filename         = data.archive_file.create_lead_lambda.output_path
  # ... rest stays the same ...
  source_code_hash = data.archive_file.create_lead_lambda.output_base64sha256
  handler          = "createLead.handler"  # Update handler name to match new file
  # ... rest stays the same ...
}
```

2. Create new file `infra/api/notifications.tf`:

```hcl
# SQS Dead Letter Queue for failed notifications
resource "aws_sqs_queue" "notifications_dlq" {
  name                      = "tropico-notifications-dlq-${var.environment}"
  message_retention_seconds = 1209600  # 14 days
  tags                      = local.tags
}

# CloudWatch Log Group for notifications Lambda
resource "aws_cloudwatch_log_group" "notifications" {
  name              = "/aws/lambda/tropico-notifications-${var.environment}"
  retention_in_days = 14
  tags              = local.tags
}

# IAM Role for notifications Lambda
resource "aws_iam_role" "notifications_lambda" {
  name = "tropico-notifications-lambda-${var.environment}"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "lambda.amazonaws.com"
        }
      }
    ]
  })

  tags = local.tags
}

# Notifications Lambda function
resource "aws_lambda_function" "notifications" {
  filename         = data.archive_file.notifications_lambda.output_path
  function_name    = "tropico-notifications-${var.environment}"
  role             = aws_iam_role.notifications_lambda.arn
  handler          = "processLeadNotifications.handler"
  source_code_hash = data.archive_file.notifications_lambda.output_base64sha256
  runtime          = "nodejs22.x"
  architectures    = ["arm64"]
  memory_size      = 256
  timeout          = 60  # Longer timeout for email sending

  environment {
    variables = {
      ENVIRONMENT         = var.environment
      TEAM_EMAILS         = var.team_emails
      FROM_EMAIL_TEAM     = var.from_email_team
      FROM_EMAIL_CUSTOMER = var.from_email_customer
      FROM_NAME           = var.from_name
    }
  }

  depends_on = [aws_cloudwatch_log_group.notifications]
  tags       = local.tags
}

# Event source mapping: DynamoDB Streams -> Lambda
resource "aws_lambda_event_source_mapping" "leads_stream" {
  event_source_arn  = aws_dynamodb_table.leads.stream_arn
  function_name     = aws_lambda_function.notifications.arn
  starting_position = "LATEST"
  batch_size        = 10

  # Only process INSERT events (new leads)
  filter_criteria {
    filter {
      pattern = jsonencode({
        eventName = ["INSERT"]
      })
    }
  }

  # Failure handling - send to DLQ
  destination_config {
    on_failure {
      destination_arn = aws_sqs_queue.notifications_dlq.arn
    }
  }

  maximum_retry_attempts        = 3
  maximum_record_age_in_seconds = 3600  # 1 hour max age
  bisect_batch_on_function_error = true
}
```
  </action>
  <verify>
```bash
cd infra && terraform validate
```
Should pass with no errors.
  </verify>
  <done>
Notification Lambda, DLQ, and event source mapping resources defined.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add IAM policies and deploy infrastructure</name>
  <files>infra/api/iam.tf</files>
  <action>
1. Add IAM policies to `infra/api/iam.tf` for the notifications Lambda:

```hcl
# === Notifications Lambda IAM Policies ===

# CloudWatch Logs permissions for notifications Lambda
resource "aws_iam_role_policy" "notifications_logs" {
  name = "cloudwatch-logs"
  role = aws_iam_role.notifications_lambda.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents"
        ]
        Resource = "arn:aws:logs:${var.aws_region}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/tropico-notifications-${var.environment}:*"
      }
    ]
  })
}

# DynamoDB Streams permissions for notifications Lambda
resource "aws_iam_role_policy" "notifications_streams" {
  name = "dynamodb-streams"
  role = aws_iam_role.notifications_lambda.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "dynamodb:GetRecords",
          "dynamodb:GetShardIterator",
          "dynamodb:DescribeStream",
          "dynamodb:ListStreams"
        ]
        Resource = "${aws_dynamodb_table.leads.arn}/stream/*"
      }
    ]
  })
}

# SES send permissions for notifications Lambda
resource "aws_iam_role_policy" "notifications_ses" {
  name = "ses-send-email"
  role = aws_iam_role.notifications_lambda.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "ses:SendEmail",
          "ses:SendRawEmail"
        ]
        Resource = [
          "arn:aws:ses:${var.aws_region}:${data.aws_caller_identity.current.account_id}:identity/${local.domain_name}",
          "arn:aws:ses:${var.aws_region}:${data.aws_caller_identity.current.account_id}:identity/*"
        ]
      }
    ]
  })
}

# SQS DLQ permissions for notifications Lambda (to send failed messages)
resource "aws_iam_role_policy" "notifications_dlq" {
  name = "sqs-dlq"
  role = aws_iam_role.notifications_lambda.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "sqs:SendMessage"
        ]
        Resource = aws_sqs_queue.notifications_dlq.arn
      }
    ]
  })
}
```

2. Build the backend before deploying (since Terraform needs the new files):

```bash
cd ../backend && npm run build
```

3. Deploy the infrastructure:

```bash
cd ../infra && terraform apply -auto-approve
```

4. Verify deployment:
```bash
aws lambda get-function --function-name tropico-notifications-dev --query 'Configuration.FunctionName'
aws dynamodb describe-table --table-name tropico-leads-dev --query 'Table.StreamSpecification'
aws sqs get-queue-url --queue-name tropico-notifications-dlq-dev
```
  </action>
  <verify>
All three commands should return:
- Lambda function name: "tropico-notifications-dev"
- StreamSpecification.StreamEnabled: true
- QueueUrl for the DLQ
  </verify>
  <done>
All IAM policies created, infrastructure deployed. Notification Lambda is connected to DynamoDB Streams with INSERT filter and DLQ for failures.
  </done>
</task>

</tasks>

<verification>
Overall phase 03-03 verification:

1. DynamoDB Streams enabled:
```bash
aws dynamodb describe-table --table-name tropico-leads-dev --query 'Table.StreamSpecification'
```
Expected: StreamEnabled: true, StreamViewType: NEW_IMAGE

2. Notification Lambda exists:
```bash
aws lambda get-function --function-name tropico-notifications-dev
```

3. Event source mapping exists:
```bash
aws lambda list-event-source-mappings --function-name tropico-notifications-dev
```
Should show one mapping with DynamoDB stream as source

4. DLQ exists:
```bash
aws sqs get-queue-attributes --queue-url $(aws sqs get-queue-url --queue-name tropico-notifications-dlq-dev --query QueueUrl --output text) --attribute-names All
```

5. IAM policies attached:
```bash
aws iam list-role-policies --role-name tropico-notifications-lambda-dev
```
Should list: cloudwatch-logs, dynamodb-streams, ses-send-email, sqs-dlq
</verification>

<success_criteria>
1. DynamoDB table has StreamEnabled=true with NEW_IMAGE view type
2. tropico-notifications-dev Lambda deployed with correct handler
3. Event source mapping configured with INSERT filter and 3 retry attempts
4. SQS DLQ created with 14-day retention
5. All 4 IAM policies attached to notifications Lambda role
6. Terraform state shows all new resources
</success_criteria>

<output>
After completion, create `.planning/phases/03-notifications/03-03-SUMMARY.md`
</output>
