---
phase: 07-slack-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/lib/slack.ts
  - backend/src/templates/slackNotification.ts
  - backend/src/handlers/processLeadNotifications.ts
  - infra/api/secrets.tf
  - infra/api/iam.tf
  - infra/api/notifications.tf
autonomous: false

user_setup:
  - service: slack
    why: "Slack Incoming Webhook for lead notifications"
    env_vars:
      - name: SLACK_WEBHOOK_URL
        source: "Slack App Settings -> Incoming Webhooks -> Create New Webhook"
    dashboard_config:
      - task: "Create Incoming Webhook"
        location: "https://api.slack.com/apps -> Create New App -> Incoming Webhooks -> Add New Webhook to Workspace"
      - task: "Store webhook URL in Secrets Manager"
        location: "AWS Console -> Secrets Manager -> tropico/slack-webhook-url-production"

must_haves:
  truths:
    - "New lead submission triggers Slack message within seconds"
    - "Slack message includes lead name, contact info, source, and dashboard link"
    - "Message displays lead temperature with visual indicator (emoji)"
    - "Slack webhook URL stored securely in AWS Secrets Manager"
  artifacts:
    - path: "backend/src/lib/slack.ts"
      provides: "Slack webhook client with secret caching"
      exports: ["sendSlackNotification"]
    - path: "backend/src/templates/slackNotification.ts"
      provides: "Block Kit message builder for lead notifications"
      exports: ["buildLeadNotificationBlocks"]
    - path: "infra/api/secrets.tf"
      provides: "AWS Secrets Manager secret for webhook URL"
      contains: "aws_secretsmanager_secret"
  key_links:
    - from: "backend/src/handlers/processLeadNotifications.ts"
      to: "backend/src/lib/slack.ts"
      via: "import sendSlackNotification"
      pattern: "await sendSlackNotification"
    - from: "backend/src/lib/slack.ts"
      to: "AWS Secrets Manager"
      via: "GetSecretValueCommand"
      pattern: "SLACK_WEBHOOK_SECRET_NAME"
    - from: "infra/api/notifications.tf"
      to: "infra/api/secrets.tf"
      via: "Lambda environment variable"
      pattern: "SLACK_WEBHOOK_SECRET_NAME.*slack_webhook"
---

<objective>
Add Slack notifications to the lead notification system so team receives instant alerts when new leads arrive.

Purpose: Team members get immediate visibility into new leads via Slack channel, enabling faster response times without constantly checking email or dashboard.

Output: Extended processLeadNotifications Lambda that sends Block Kit formatted Slack messages with lead details, temperature emoji, and dashboard link. Webhook URL stored securely in AWS Secrets Manager.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-slack-notifications/07-RESEARCH.md

# Existing code patterns
@backend/src/lib/ses.ts (client singleton pattern)
@backend/src/handlers/processLeadNotifications.ts (handler to extend)
@backend/src/lib/types.ts (Lead type)
@backend/src/templates/teamNotification.ts (template pattern)
@infra/api/notifications.tf (Lambda configuration)
@infra/api/iam.tf (IAM policies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend Slack notification module and template</name>
  <files>
    - backend/package.json
    - backend/src/lib/slack.ts
    - backend/src/templates/slackNotification.ts
    - backend/src/handlers/processLeadNotifications.ts
  </files>
  <action>
    1. Install @slack/webhook dependency:
       ```bash
       cd backend && npm install @slack/webhook
       ```

    2. Create `backend/src/lib/slack.ts`:
       - Import IncomingWebhook from @slack/webhook
       - Import SecretsManagerClient, GetSecretValueCommand from @aws-sdk/client-secrets-manager
       - Create secretsClient singleton (outside handler, like ses.ts pattern)
       - Cache webhook URL at module level: `let cachedWebhookUrl: string | null = null`
       - Cache webhook instance: `let webhookInstance: IncomingWebhook | null = null`
       - Implement `getWebhookUrl()` that reads from Secrets Manager (SLACK_WEBHOOK_SECRET_NAME env var)
       - Export `sendSlackNotification(blocks: unknown[], text: string): Promise<void>`
       - Use try/catch and only log error.message (not full error - may contain URL)

    3. Create `backend/src/templates/slackNotification.ts`:
       - Import Lead type from '../lib/types.js'
       - Define TEMPERATURE_EMOJI map: HOT -> ':fire:', WARM -> ':sun:', COLD -> ':snowflake:'
       - Export `buildLeadNotificationBlocks(lead: Lead, dashboardUrl: string): { blocks: unknown[]; text: string }`
       - Build Block Kit message with:
         - Header block: "{emoji} New Lead: {displayName}" (company or firstName lastName)
         - Section block with fields: Name, Email, Phone (if exists), Company (if exists)
         - Section block: Message (truncated to 500 chars if longer)
         - Divider
         - Context block: "Temperature: {emoji} {temp} | <dashboardUrl/leads/{id}|View in Dashboard>"
       - Return fallback `text` for notifications: "New lead from {displayName}"

    4. Update `backend/src/handlers/processLeadNotifications.ts`:
       - Add import: `import { sendSlackNotification } from '../lib/slack.js'`
       - Add import: `import { buildLeadNotificationBlocks } from '../templates/slackNotification.js'`
       - After the customer auto-reply try/catch block, add new try/catch for Slack:
         ```typescript
         // Send Slack notification
         try {
           const { blocks, text } = buildLeadNotificationBlocks(lead, ADMIN_DASHBOARD_URL);
           await sendSlackNotification(blocks, text);
           console.log(`Slack notification sent for lead ${lead.id}`);
         } catch (error) {
           console.error(`Failed to send Slack notification for lead ${lead.id}:`, error instanceof Error ? error.message : error);
           // Continue processing - Slack failure should not block other notifications
         }
         ```
       - Add SLACK_WEBHOOK_SECRET_NAME to env var doc comment at top

    5. Build to verify no TypeScript errors:
       ```bash
       cd backend && npm run build
       ```
  </action>
  <verify>
    - `ls backend/node_modules/@slack/webhook` confirms package installed
    - `backend/src/lib/slack.ts` exists with sendSlackNotification export
    - `backend/src/templates/slackNotification.ts` exists with buildLeadNotificationBlocks export
    - `backend/src/handlers/processLeadNotifications.ts` imports and calls Slack functions
    - `npm run build` succeeds without TypeScript errors
  </verify>
  <done>
    Backend code complete: Slack module with secret caching, Block Kit template with temperature emoji, handler extended with Slack notification call (non-blocking pattern).
  </done>
</task>

<task type="auto">
  <name>Task 2: Terraform infrastructure for Secrets Manager and Lambda permissions</name>
  <files>
    - infra/api/secrets.tf
    - infra/api/iam.tf
    - infra/api/notifications.tf
  </files>
  <action>
    1. Create `infra/api/secrets.tf`:
       ```hcl
       # Slack webhook URL secret
       # Value must be set manually: aws secretsmanager put-secret-value --secret-id tropico/slack-webhook-url-production --secret-string "https://hooks.slack.com/services/..."
       resource "aws_secretsmanager_secret" "slack_webhook" {
         name        = "tropico/slack-webhook-url-${var.environment}"
         description = "Slack incoming webhook URL for lead notifications"
         tags        = local.tags
       }
       ```

    2. Update `infra/api/iam.tf` - add new policy after existing notifications_dlq policy:
       ```hcl
       # Secrets Manager permissions for Notification Lambda (Slack webhook URL)
       resource "aws_iam_role_policy" "notifications_secrets" {
         name = "secrets-manager"
         role = aws_iam_role.notifications_lambda.id

         policy = jsonencode({
           Version = "2012-10-17"
           Statement = [
             {
               Effect   = "Allow"
               Action   = ["secretsmanager:GetSecretValue"]
               Resource = aws_secretsmanager_secret.slack_webhook.arn
             }
           ]
         })
       }
       ```

    3. Update `infra/api/notifications.tf` - add SLACK_WEBHOOK_SECRET_NAME to Lambda environment variables:
       Find the `environment` block in `aws_lambda_function.notifications` and add:
       ```hcl
       SLACK_WEBHOOK_SECRET_NAME = aws_secretsmanager_secret.slack_webhook.name
       ADMIN_DASHBOARD_URL       = "https://${var.admin_domain}"
       ```
       (Note: ADMIN_DASHBOARD_URL may already exist as hardcoded - update to use var.admin_domain)

    4. Run Terraform validate:
       ```bash
       cd infra/api && terraform validate
       ```

    5. Run Terraform plan to preview changes:
       ```bash
       cd infra/api && terraform plan
       ```
       Expected changes:
       - Create: aws_secretsmanager_secret.slack_webhook
       - Create: aws_iam_role_policy.notifications_secrets
       - Update: aws_lambda_function.notifications (new env vars)
  </action>
  <verify>
    - `infra/api/secrets.tf` exists with aws_secretsmanager_secret.slack_webhook
    - `infra/api/iam.tf` contains aws_iam_role_policy.notifications_secrets
    - `infra/api/notifications.tf` environment block includes SLACK_WEBHOOK_SECRET_NAME
    - `terraform validate` passes
    - `terraform plan` shows expected resources
  </verify>
  <done>
    Terraform infrastructure complete: Secrets Manager secret defined, IAM policy grants Lambda access to secret, Lambda environment variable configured to reference secret name.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Slack notification integration for the lead notification Lambda:
    - @slack/webhook library installed
    - Slack client module with Secrets Manager caching (backend/src/lib/slack.ts)
    - Block Kit message template with temperature emoji (backend/src/templates/slackNotification.ts)
    - processLeadNotifications handler extended with Slack notification
    - Terraform: Secrets Manager secret, IAM policy, Lambda env var
  </what-built>
  <how-to-verify>
    **Pre-deployment setup (required):**

    1. Create Slack Incoming Webhook:
       - Go to https://api.slack.com/apps
       - Create New App (or use existing) -> From scratch
       - Name: "Tropico Leads", Workspace: Your workspace
       - Features -> Incoming Webhooks -> Activate
       - Add New Webhook to Workspace -> Select channel (e.g., #leads)
       - Copy the webhook URL (starts with https://hooks.slack.com/services/...)

    2. Deploy infrastructure and store secret:
       ```bash
       cd infra/api && terraform apply
       ```

    3. Store webhook URL in Secrets Manager:
       ```bash
       aws secretsmanager put-secret-value \
         --secret-id tropico/slack-webhook-url-production \
         --secret-string "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
       ```

    4. Deploy updated Lambda:
       ```bash
       cd backend && npm run build
       cd ../infra/api && terraform apply
       ```

    **Verification:**

    5. Submit a test lead via the contact form at https://tropicoretreat.com/contact

    6. Within seconds, verify in Slack channel:
       - [ ] Message appears with header "{emoji} New Lead: {name}"
       - [ ] Contact details shown (name, email, phone if provided)
       - [ ] Message content displayed
       - [ ] Temperature emoji matches lead temperature (default WARM = :sun:)
       - [ ] "View in Dashboard" link works and goes to correct lead

    7. Check CloudWatch logs for confirmation:
       ```bash
       aws logs tail /aws/lambda/tropico-notifications-production --since 5m
       ```
       Look for: "Slack notification sent for lead {id}"

    8. Verify email notifications still work (Slack failure should not break emails)
  </how-to-verify>
  <resume-signal>Type "approved" if Slack notifications work correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 7 verification checklist:

**Requirement NOTIF-03:** Team receives Slack message within seconds of new lead with lead details and dashboard link

1. **Functional:**
   - [ ] New lead triggers Slack message (not just email)
   - [ ] Message arrives within seconds (Lambda processes INSERT event)
   - [ ] Message includes: name, email, phone (if present), company (if present), message
   - [ ] Dashboard link in message navigates to correct lead
   - [ ] Temperature emoji displays correctly (HOT=:fire:, WARM=:sun:, COLD=:snowflake:)

2. **Security:**
   - [ ] Webhook URL NOT in Lambda environment variables (stored in Secrets Manager)
   - [ ] Webhook URL NOT visible in CloudWatch logs
   - [ ] IAM policy scoped to specific secret ARN (not wildcard)

3. **Reliability:**
   - [ ] Slack failure does NOT block email notifications
   - [ ] Secret cached at cold start (not fetched per invocation)
   - [ ] Error messages logged without exposing webhook URL

4. **Infrastructure:**
   - [ ] Secrets Manager secret exists in AWS console
   - [ ] Lambda has SLACK_WEBHOOK_SECRET_NAME env var
   - [ ] IAM policy allows secretsmanager:GetSecretValue
</verification>

<success_criteria>
Phase 7 is complete when:
1. A new lead submitted via contact form triggers a Slack notification within seconds
2. The Slack message displays lead name, contact info (email, phone), message content, and dashboard link
3. The message shows the correct temperature emoji based on lead.temperature
4. The Slack webhook URL is stored in AWS Secrets Manager (not in environment variables or code)
5. Email notifications continue to work even if Slack fails
</success_criteria>

<output>
After completion, create `.planning/phases/07-slack-notifications/07-01-SUMMARY.md`
</output>
