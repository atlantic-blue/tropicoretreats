---
phase: 05-admin-dashboard
plan: 07
type: execute
wave: 6
depends_on: ["05-05", "05-06"]
files_modified:
  - admin/src/hooks/useLeadDetail.ts
  - admin/src/hooks/useLeadMutations.ts
  - admin/src/components/leads/LeadDetail.tsx
  - admin/src/components/leads/NotesTimeline.tsx
  - admin/src/components/leads/StatusDropdown.tsx
  - admin/src/components/leads/TemperatureDropdown.tsx
  - admin/src/components/leads/AssigneeDropdown.tsx
  - admin/src/pages/LeadDetailPage.tsx
autonomous: false

must_haves:
  truths:
    - "Lead detail page shows full contact info and message"
    - "Status dropdown changes status with optimistic update"
    - "Temperature dropdown changes temperature with optimistic update"
    - "Assignee dropdown assigns lead to team member"
    - "Notes timeline shows all notes newest first"
    - "User can add a note"
    - "Status changes create system notes"
  artifacts:
    - path: "admin/src/pages/LeadDetailPage.tsx"
      provides: "Lead detail page with editing"
      contains: "NotesTimeline"
    - path: "admin/src/components/leads/NotesTimeline.tsx"
      provides: "Notes list with add note form"
      contains: "addNote"
    - path: "admin/src/hooks/useLeadMutations.ts"
      provides: "Mutations for lead updates and notes"
      exports: ["useUpdateLead", "useAddNote"]
  key_links:
    - from: "admin/src/pages/LeadDetailPage.tsx"
      to: "admin/src/hooks/useLeadMutations.ts"
      via: "uses mutation hooks"
      pattern: "useUpdateLead|useAddNote"

user_setup:
  - service: admin-deploy
    why: "Deploy admin dashboard to S3/CloudFront"
    env_vars:
      - name: AWS_ACCESS_KEY_ID
        source: "AWS IAM credentials (already configured for Terraform)"
    dashboard_config:
      - task: "No dashboard config needed - automated via AWS CLI"
        location: "N/A"
---

<objective>
Build lead detail page with editing, notes timeline, and deploy admin dashboard

Purpose: Complete the admin dashboard with the lead detail view. Per CONTEXT.md: full page detail, two-column layout (contact info left, status/temp/assignee/notes right), inline dropdowns with instant save, notes timeline with auto-logging. Finally, deploy the complete admin app to S3/CloudFront.

Output: Complete, deployed admin dashboard at admin.tropicoretreat.com
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-dashboard/05-CONTEXT.md
@.planning/phases/05-admin-dashboard/05-RESEARCH.md
@.planning/phases/05-admin-dashboard/05-05-SUMMARY.md
@.planning/phases/05-admin-dashboard/05-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mutation hooks with optimistic updates</name>
  <files>admin/src/hooks/useLeadDetail.ts, admin/src/hooks/useLeadMutations.ts</files>
  <action>
1. Create src/hooks/useLeadDetail.ts:
```typescript
import { useQuery } from '@tanstack/react-query';
import { leadsApi } from '../api/leads';

export function useLeadDetail(id: string) {
  return useQuery({
    queryKey: ['lead', id],
    queryFn: () => leadsApi.get(id),
    enabled: !!id,
  });
}
```

2. Create src/hooks/useLeadMutations.ts with optimistic updates (from 05-RESEARCH.md Pattern 1):
```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { leadsApi } from '../api/leads';
import type { Lead, LeadWithNotes, Note } from '../types/lead';

export function useUpdateLead(leadId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: Partial<Lead>) => leadsApi.update(leadId, data),
    onMutate: async (data) => {
      await queryClient.cancelQueries({ queryKey: ['lead', leadId] });
      const previousLead = queryClient.getQueryData<LeadWithNotes>(['lead', leadId]);

      if (previousLead) {
        queryClient.setQueryData<LeadWithNotes>(['lead', leadId], {
          ...previousLead,
          ...data,
        });
      }

      return { previousLead };
    },
    onError: (err, variables, context) => {
      if (context?.previousLead) {
        queryClient.setQueryData(['lead', leadId], context.previousLead);
      }
    },
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['lead', leadId] });
      queryClient.invalidateQueries({ queryKey: ['leads'] }); // Refresh list too
    },
  });
}

export function useAddNote(leadId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (content: string) => leadsApi.addNote(leadId, content),
    onMutate: async (content) => {
      await queryClient.cancelQueries({ queryKey: ['lead', leadId] });
      const previousLead = queryClient.getQueryData<LeadWithNotes>(['lead', leadId]);

      if (previousLead) {
        const optimisticNote: Note = {
          id: 'temp-' + Date.now(),
          leadId,
          content,
          authorId: 'current-user', // Will be replaced by server
          authorName: 'You',
          type: 'MANUAL',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        };

        queryClient.setQueryData<LeadWithNotes>(['lead', leadId], {
          ...previousLead,
          notes: [optimisticNote, ...previousLead.notes],
        });
      }

      return { previousLead };
    },
    onError: (err, variables, context) => {
      if (context?.previousLead) {
        queryClient.setQueryData(['lead', leadId], context.previousLead);
      }
    },
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['lead', leadId] });
    },
  });
}

export function useUpdateNote(leadId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ noteId, content }: { noteId: string; content: string }) =>
      leadsApi.updateNote(leadId, noteId, content),
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['lead', leadId] });
    },
  });
}
```
  </action>
  <verify>TypeScript compiles: `cd admin && npx tsc --noEmit`</verify>
  <done>Mutation hooks with optimistic updates for lead updates and notes</done>
</task>

<task type="auto">
  <name>Task 2: Create lead detail components</name>
  <files>admin/src/components/leads/LeadDetail.tsx, admin/src/components/leads/NotesTimeline.tsx, admin/src/components/leads/StatusDropdown.tsx, admin/src/components/leads/TemperatureDropdown.tsx, admin/src/components/leads/AssigneeDropdown.tsx</files>
  <action>
1. Create src/components/leads/StatusDropdown.tsx:
- Dropdown showing current status
- Options: NEW, CONTACTED, QUOTED, WON, LOST
- Only show valid next statuses (forward-only progression)
- On change, call updateLead mutation
- Show loading state during save
```typescript
const STATUS_ORDER: LeadStatus[] = ['NEW', 'CONTACTED', 'QUOTED', 'WON', 'LOST'];

function getValidStatuses(current: LeadStatus): LeadStatus[] {
  const currentIndex = STATUS_ORDER.indexOf(current);
  // Can progress forward, or stay at WON/LOST
  if (current === 'WON' || current === 'LOST') return ['WON', 'LOST'];
  return STATUS_ORDER.slice(currentIndex);
}
```

2. Create src/components/leads/TemperatureDropdown.tsx:
- Dropdown showing current temperature
- Options: HOT, WARM, COLD with flame icons
- On change, call updateLead mutation

3. Create src/components/leads/AssigneeDropdown.tsx:
- Dropdown showing current assignee (or "Unassigned")
- Options from useUsers hook
- On change, call updateLead with assigneeId and assigneeName

4. Create src/components/leads/NotesTimeline.tsx:
```typescript
function NotesTimeline({ notes, leadId }: { notes: Note[]; leadId: string }) {
  const [isAdding, setIsAdding] = useState(false);
  const [content, setContent] = useState('');
  const addNote = useAddNote(leadId);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    if (!content.trim()) return;
    await addNote.mutateAsync(content);
    setContent('');
    setIsAdding(false);
  };

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h3 className="font-semibold">Activity</h3>
        {!isAdding && (
          <button onClick={() => setIsAdding(true)} className="text-sm text-blue-600 hover:text-blue-800">
            + Add note
          </button>
        )}
      </div>

      {isAdding && (
        <form onSubmit={handleSubmit} className="space-y-2">
          <textarea
            value={content}
            onChange={e => setContent(e.target.value)}
            className="w-full border rounded p-2"
            placeholder="Add a note..."
            rows={3}
            autoFocus
          />
          <div className="flex gap-2">
            <button type="submit" disabled={addNote.isPending} className="px-3 py-1 bg-blue-600 text-white rounded">
              {addNote.isPending ? 'Saving...' : 'Save'}
            </button>
            <button type="button" onClick={() => setIsAdding(false)} className="px-3 py-1 border rounded">
              Cancel
            </button>
          </div>
        </form>
      )}

      <div className="space-y-3">
        {notes.map(note => (
          <NoteItem key={note.id} note={note} leadId={leadId} />
        ))}
      </div>
    </div>
  );
}

function NoteItem({ note, leadId }: { note: Note; leadId: string }) {
  const [isEditing, setIsEditing] = useState(false);
  const updateNote = useUpdateNote(leadId);
  // ... edit form similar to add form

  const isSystem = note.type === 'SYSTEM';

  return (
    <div className={`p-3 rounded ${isSystem ? 'bg-gray-50' : 'bg-white border'}`}>
      <div className="flex justify-between text-sm text-gray-500">
        <span className="font-medium">{note.authorName}</span>
        <span>{formatDistanceToNow(new Date(note.createdAt), { addSuffix: true })}</span>
      </div>
      {isEditing ? (
        /* edit form */
      ) : (
        <p className={`mt-1 ${isSystem ? 'text-gray-600 italic' : ''}`}>{note.content}</p>
      )}
      {!isSystem && !isEditing && (
        <button onClick={() => setIsEditing(true)} className="text-xs text-gray-400 hover:text-gray-600 mt-1">
          Edit
        </button>
      )}
    </div>
  );
}
```

5. Create src/components/leads/LeadDetail.tsx:
- Two-column layout: left (contact info + message), right (dropdowns + notes)
- Contact info: name, email, phone, company, group size, dates, destination
- Message in separate card
- Status, Temperature, Assignee dropdowns on right
- NotesTimeline below dropdowns
  </action>
  <verify>TypeScript compiles: `cd admin && npx tsc --noEmit`</verify>
  <done>All lead detail components created with inline editing and notes timeline</done>
</task>

<task type="auto">
  <name>Task 3: Create lead detail page and update routing</name>
  <files>admin/src/pages/LeadDetailPage.tsx, admin/src/App.tsx</files>
  <action>
1. Create src/pages/LeadDetailPage.tsx:
```typescript
import { useParams, Link } from 'react-router';
import { useLeadDetail } from '../hooks/useLeadDetail';
import { LeadDetail } from '../components/leads/LeadDetail';
import { ChevronLeft } from 'lucide-react';

export function LeadDetailPage() {
  const { id } = useParams<{ id: string }>();
  const { data: lead, isLoading, isError, error } = useLeadDetail(id!);

  if (isLoading) return <LoadingSkeleton />;
  if (isError) return <ErrorMessage error={error} />;
  if (!lead) return <NotFound />;

  return (
    <div className="space-y-6">
      {/* Breadcrumb navigation */}
      <nav className="flex items-center gap-2 text-sm">
        <Link to="/leads" className="flex items-center gap-1 text-gray-600 hover:text-gray-900">
          <ChevronLeft className="w-4 h-4" />
          Leads
        </Link>
        <span className="text-gray-400">/</span>
        <span className="text-gray-900">{lead.firstName} {lead.lastName}</span>
      </nav>

      <LeadDetail lead={lead} />
    </div>
  );
}
```

2. Update App.tsx routing to use LeadDetailPage:
```typescript
<Route path="leads/:id" element={<LeadDetailPage />} />
```

3. Initialize token getter in App.tsx or AuthProvider:
```typescript
// In AuthProvider, after auth state is set:
useEffect(() => {
  if (getAccessToken) {
    setTokenGetter(getAccessToken);
  }
}, [getAccessToken]);
```
  </action>
  <verify>
- Navigate to /leads/{id} shows detail page
- Status dropdown changes status
- Temperature dropdown changes temperature
- Assignee dropdown lists users and changes assignee
- Add note appears in timeline
- System notes appear for status/temp/assignee changes
  </verify>
  <done>Lead detail page with all editing features working</done>
</task>

<task type="auto">
  <name>Task 4: Build and deploy admin dashboard</name>
  <files>admin/package.json</files>
  <action>
1. Create production .env file with correct values:
```env
VITE_COGNITO_USER_POOL_ID=us-east-1_vWmyWWEwX
VITE_COGNITO_CLIENT_ID=i1req5nr80ihn4skjelp0ldp1
VITE_API_ENDPOINT=https://u57cra1p8h.execute-api.us-east-1.amazonaws.com
```

2. Build the production bundle:
```bash
cd admin
npm run build
```

3. Verify build output exists in admin/dist/

4. Upload to S3:
```bash
aws s3 sync admin/dist/ s3://admin.tropicoretreat.com/ --delete
```

5. Invalidate CloudFront cache:
```bash
# Get distribution ID from terraform output
DIST_ID=$(cd infra && terraform output -raw admin_cloudfront_distribution_id)
aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"
```

6. Add deploy script to admin/package.json:
```json
"scripts": {
  "deploy": "npm run build && aws s3 sync dist/ s3://admin.tropicoretreat.com/ --delete"
}
```
  </action>
  <verify>
- `cd admin && npm run build` succeeds
- `aws s3 ls s3://admin.tropicoretreat.com/` shows files
- https://admin.tropicoretreat.com loads login page
  </verify>
  <done>Admin dashboard deployed to admin.tropicoretreat.com</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin dashboard with authentication, lead list, lead detail editing, notes, and deployment</what-built>
  <how-to-verify>
1. Go to https://admin.tropicoretreat.com
2. Login with admin@tropicoretreat.com
3. Verify lead list shows cards with status badges and temperature icons
4. Click a lead card to view details
5. Change lead status using dropdown - verify it saves
6. Change temperature using dropdown - verify flame icon updates
7. Assign lead to a team member
8. Add a note - verify it appears in timeline
9. Verify system notes appear when status/temp/assignee changes
10. Check URL filters work (add ?status=NEW and refresh)
11. Test sign out
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
All checks:
1. Admin dashboard loads at https://admin.tropicoretreat.com
2. Login works with Cognito credentials
3. Lead list displays with cards, filters, pagination
4. Lead detail page shows all information
5. Status dropdown with forward-only progression
6. Temperature dropdown with flame icons
7. Assignee dropdown populated from Cognito users
8. Notes timeline with add/edit functionality
9. System notes auto-created on field changes
10. Sign out works
</verification>

<success_criteria>
1. Admin dashboard deployed and accessible
2. All DASH-01 through DASH-07 requirements met:
   - DASH-01: Admin dashboard frontend (deployed)
   - DASH-02: Lead listing view with search/filter (cards, URL filters)
   - DASH-03: Lead detail view (full page with all info)
   - DASH-04: Lead status tracking (dropdown with progression)
   - DASH-05: Temperature rating (flame icon dropdown)
   - DASH-06: Notes on leads (timeline with add/edit)
   - DASH-07: Lead assignment (Cognito user dropdown)
3. User approves checkpoint verification
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-dashboard/05-07-SUMMARY.md`
</output>
