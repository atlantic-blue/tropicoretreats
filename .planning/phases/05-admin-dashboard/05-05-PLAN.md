---
phase: 05-admin-dashboard
plan: 05
type: execute
wave: 4
depends_on: []
files_modified:
  - infra/admin-s3.tf
  - infra/admin-cloudfront.tf
  - infra/admin-acm.tf
  - infra/admin-route53.tf
  - infra/_vars.tf
  - infra/_outputs.tf
autonomous: true

must_haves:
  truths:
    - "S3 bucket for admin.tropicoretreat.com exists"
    - "CloudFront distribution serves from S3"
    - "ACM certificate for admin subdomain exists"
    - "Route53 A record points to CloudFront"
  artifacts:
    - path: "infra/admin-s3.tf"
      provides: "S3 bucket for admin dashboard static files"
      contains: "aws_s3_bucket.*admin"
    - path: "infra/admin-cloudfront.tf"
      provides: "CloudFront distribution for admin"
      contains: "aws_cloudfront_distribution.*admin"
  key_links:
    - from: "infra/admin-cloudfront.tf"
      to: "infra/admin-s3.tf"
      via: "origin points to S3 bucket"
      pattern: "aws_s3_bucket\\.admin\\.bucket_regional_domain_name"
---

<objective>
Create Terraform infrastructure for admin dashboard hosting (S3 + CloudFront)

Purpose: The admin dashboard needs to be deployed to admin.tropicoretreat.com. This plan creates the S3 bucket for static files, CloudFront distribution for HTTPS and caching, ACM certificate for SSL, and Route53 record for DNS. This is independent of the React app build and can be done in parallel.

Output: Deployed infrastructure ready to receive admin SPA build artifacts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing infrastructure patterns
@infra/s3.tf
@infra/cloudfront.tf
@infra/acm.tf
@infra/route53.tf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create S3 bucket for admin dashboard</name>
  <files>infra/admin-s3.tf</files>
  <action>
Create S3 bucket for admin dashboard static files. Follow existing s3.tf pattern.

```hcl
# S3 bucket for admin dashboard
resource "aws_s3_bucket" "admin" {
  bucket = "admin.tropicoretreat.com"
  tags   = local.tags
}

resource "aws_s3_bucket_public_access_block" "admin" {
  bucket = aws_s3_bucket.admin.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# CloudFront Origin Access Control
resource "aws_cloudfront_origin_access_control" "admin" {
  name                              = "admin-oac"
  description                       = "OAC for admin dashboard"
  origin_access_control_origin_type = "s3"
  signing_behavior                  = "always"
  signing_protocol                  = "sigv4"
}

# S3 bucket policy to allow CloudFront access
resource "aws_s3_bucket_policy" "admin" {
  bucket = aws_s3_bucket.admin.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid       = "AllowCloudFrontServicePrincipal"
        Effect    = "Allow"
        Principal = {
          Service = "cloudfront.amazonaws.com"
        }
        Action   = "s3:GetObject"
        Resource = "${aws_s3_bucket.admin.arn}/*"
        Condition = {
          StringEquals = {
            "AWS:SourceArn" = aws_cloudfront_distribution.admin.arn
          }
        }
      }
    ]
  })
}
```
  </action>
  <verify>`cd infra && terraform validate` passes</verify>
  <done>S3 bucket admin.tropicoretreat.com with OAC and bucket policy</done>
</task>

<task type="auto">
  <name>Task 2: Create ACM certificate and CloudFront distribution</name>
  <files>infra/admin-acm.tf, infra/admin-cloudfront.tf</files>
  <action>
1. Create admin-acm.tf for SSL certificate:
```hcl
# ACM certificate for admin subdomain (must be in us-east-1 for CloudFront)
resource "aws_acm_certificate" "admin" {
  provider          = aws.us_east_1  # If using aliased provider
  domain_name       = "admin.tropicoretreat.com"
  validation_method = "DNS"

  lifecycle {
    create_before_destroy = true
  }

  tags = local.tags
}

# DNS validation record
resource "aws_route53_record" "admin_cert_validation" {
  for_each = {
    for dvo in aws_acm_certificate.admin.domain_validation_options : dvo.domain_name => {
      name   = dvo.resource_record_name
      record = dvo.resource_record_value
      type   = dvo.resource_record_type
    }
  }

  allow_overwrite = true
  name            = each.value.name
  records         = [each.value.record]
  ttl             = 60
  type            = each.value.type
  zone_id         = data.aws_route53_zone.main.zone_id
}

resource "aws_acm_certificate_validation" "admin" {
  certificate_arn         = aws_acm_certificate.admin.arn
  validation_record_fqdns = [for record in aws_route53_record.admin_cert_validation : record.fqdn]
}
```

Note: If existing infra uses a single provider, check if ACM certificate is already in us-east-1. CloudFront requires certificates in us-east-1. Adjust provider configuration as needed.

2. Create admin-cloudfront.tf:
```hcl
resource "aws_cloudfront_distribution" "admin" {
  origin {
    domain_name              = aws_s3_bucket.admin.bucket_regional_domain_name
    origin_access_control_id = aws_cloudfront_origin_access_control.admin.id
    origin_id                = "admin-s3"
  }

  enabled             = true
  is_ipv6_enabled     = true
  default_root_object = "index.html"
  aliases             = ["admin.tropicoretreat.com"]

  default_cache_behavior {
    allowed_methods  = ["GET", "HEAD", "OPTIONS"]
    cached_methods   = ["GET", "HEAD"]
    target_origin_id = "admin-s3"

    forwarded_values {
      query_string = false
      cookies {
        forward = "none"
      }
    }

    viewer_protocol_policy = "redirect-to-https"
    min_ttl                = 0
    default_ttl            = 3600
    max_ttl                = 86400
  }

  # SPA routing: return index.html for 404s
  custom_error_response {
    error_code         = 404
    response_code      = 200
    response_page_path = "/index.html"
  }

  custom_error_response {
    error_code         = 403
    response_code      = 200
    response_page_path = "/index.html"
  }

  price_class = "PriceClass_100"

  restrictions {
    geo_restriction {
      restriction_type = "none"
    }
  }

  viewer_certificate {
    acm_certificate_arn      = aws_acm_certificate_validation.admin.certificate_arn
    ssl_support_method       = "sni-only"
    minimum_protocol_version = "TLSv1.2_2021"
  }

  tags = local.tags
}
```
  </action>
  <verify>`cd infra && terraform validate` passes</verify>
  <done>ACM certificate and CloudFront distribution configured for admin.tropicoretreat.com</done>
</task>

<task type="auto">
  <name>Task 3: Create Route53 record and deploy</name>
  <files>infra/admin-route53.tf, infra/_outputs.tf</files>
  <action>
1. Create admin-route53.tf:
```hcl
# Route53 record pointing to CloudFront
resource "aws_route53_record" "admin" {
  zone_id = data.aws_route53_zone.main.zone_id
  name    = "admin.tropicoretreat.com"
  type    = "A"

  alias {
    name                   = aws_cloudfront_distribution.admin.domain_name
    zone_id                = aws_cloudfront_distribution.admin.hosted_zone_id
    evaluate_target_health = false
  }
}
```

2. Add outputs to _outputs.tf:
```hcl
output "admin_bucket_name" {
  value = aws_s3_bucket.admin.id
}

output "admin_cloudfront_distribution_id" {
  value = aws_cloudfront_distribution.admin.id
}

output "admin_cloudfront_domain" {
  value = aws_cloudfront_distribution.admin.domain_name
}
```

3. Check if data source for route53 zone exists. If not, add:
```hcl
data "aws_route53_zone" "main" {
  name = "tropicoretreat.com"
}
```

4. Deploy:
```bash
cd infra
terraform plan
terraform apply -auto-approve
```

Note: Certificate validation may take a few minutes. CloudFront distribution creation takes 10-15 minutes.

5. After deployment, verify:
- S3 bucket exists
- CloudFront distribution is deployed
- DNS record resolves (may take time to propagate)
  </action>
  <verify>
- `terraform apply` completes
- `aws s3 ls s3://admin.tropicoretreat.com` works
- `nslookup admin.tropicoretreat.com` returns CloudFront domain
- `curl -I https://admin.tropicoretreat.com` returns 200 or 403 (empty bucket)
  </verify>
  <done>Admin infrastructure deployed; DNS configured; ready for build upload</done>
</task>

</tasks>

<verification>
All checks:
1. S3 bucket admin.tropicoretreat.com exists
2. CloudFront distribution is deployed and enabled
3. ACM certificate is validated
4. DNS record points to CloudFront
5. https://admin.tropicoretreat.com is accessible (will show error until files uploaded)
</verification>

<success_criteria>
1. S3 bucket with OAC and CloudFront access policy
2. ACM certificate for admin.tropicoretreat.com validated
3. CloudFront distribution with SPA error handling
4. Route53 A record aliased to CloudFront
5. Terraform outputs for bucket name and distribution ID
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-dashboard/05-05-SUMMARY.md`
</output>
