---
phase: 05-admin-dashboard
plan: 04
type: execute
wave: 4
depends_on: []
files_modified:
  - admin/package.json
  - admin/vite.config.ts
  - admin/tailwind.config.ts
  - admin/tsconfig.json
  - admin/index.html
  - admin/src/main.tsx
  - admin/src/App.tsx
  - admin/src/lib/cognito.ts
  - admin/src/lib/queryClient.ts
  - admin/src/contexts/AuthContext.tsx
  - admin/src/hooks/useAuth.ts
  - admin/src/pages/LoginPage.tsx
  - admin/src/components/layout/AppShell.tsx
  - admin/src/index.css
  - admin/.env.example
autonomous: true

must_haves:
  truths:
    - "Admin app runs with `npm run dev`"
    - "Login page authenticates with Cognito"
    - "Protected routes redirect to login if not authenticated"
    - "Authenticated user can see app shell with header"
  artifacts:
    - path: "admin/src/App.tsx"
      provides: "App with routing and auth"
      contains: "AuthProvider"
    - path: "admin/src/contexts/AuthContext.tsx"
      provides: "Cognito authentication context"
      exports: ["AuthProvider", "useAuth"]
    - path: "admin/src/pages/LoginPage.tsx"
      provides: "Login form with Cognito"
      contains: "signIn"
  key_links:
    - from: "admin/src/contexts/AuthContext.tsx"
      to: "amazon-cognito-identity-js"
      via: "imports CognitoUserPool"
      pattern: "import.*CognitoUserPool.*from.*amazon-cognito-identity-js"
---

<objective>
Scaffold admin dashboard React app with Vite, Cognito auth, and TanStack Query

Purpose: Create the foundation for the admin dashboard - a Vite + React 19 + TypeScript app with authentication via amazon-cognito-identity-js, routing via React Router, and server state via TanStack Query. This plan focuses on the app scaffold and authentication; lead pages are in subsequent plans.

Output: Working admin app with login page, auth context, protected route shell, ready for lead list/detail pages
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-dashboard/05-CONTEXT.md
@.planning/phases/05-admin-dashboard/05-RESEARCH.md
@.planning/phases/04-admin-auth/04-01-SUMMARY.md
@.planning/phases/04-admin-auth/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vite React app with dependencies</name>
  <files>admin/</files>
  <action>
1. Create admin directory at project root (alongside backend/, frontend/, infra/)

2. Initialize Vite React TypeScript project:
```bash
cd /path/to/project
npm create vite@latest admin -- --template react-ts
cd admin
```

3. Install dependencies:
```bash
npm install @tanstack/react-query react-router amazon-cognito-identity-js date-fns lucide-react
npm install -D tailwindcss @tailwindcss/postcss postcss autoprefixer
```

4. Initialize Tailwind:
```bash
npx tailwindcss init -p
```

5. Configure tailwind.config.ts:
```typescript
import type { Config } from 'tailwindcss';

export default {
  content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],
  theme: {
    extend: {},
  },
  plugins: [],
} satisfies Config;
```

6. Create src/index.css with Tailwind directives:
```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

7. Create .env.example:
```env
VITE_COGNITO_USER_POOL_ID=us-east-1_xxxxxxxxx
VITE_COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx
VITE_API_ENDPOINT=https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com
```

8. Create .env (gitignored) with actual values from Phase 4:
```env
VITE_COGNITO_USER_POOL_ID=us-east-1_vWmyWWEwX
VITE_COGNITO_CLIENT_ID=i1req5nr80ihn4skjelp0ldp1
VITE_API_ENDPOINT=https://u57cra1p8h.execute-api.us-east-1.amazonaws.com
```

9. Add .env to .gitignore

10. Update vite.config.ts:
```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5174, // Different from frontend (5173)
  },
});
```
  </action>
  <verify>
- `cd admin && npm run dev` starts server on port 5174
- Tailwind CSS works (add a test class to see styling)
  </verify>
  <done>Admin Vite app created with all dependencies installed; runs on port 5174</done>
</task>

<task type="auto">
  <name>Task 2: Create auth context and Cognito integration</name>
  <files>admin/src/lib/cognito.ts, admin/src/contexts/AuthContext.tsx, admin/src/hooks/useAuth.ts</files>
  <action>
1. Create src/lib/cognito.ts - Cognito configuration:
```typescript
import { CognitoUserPool } from 'amazon-cognito-identity-js';

const poolData = {
  UserPoolId: import.meta.env.VITE_COGNITO_USER_POOL_ID,
  ClientId: import.meta.env.VITE_COGNITO_CLIENT_ID,
};

if (!poolData.UserPoolId || !poolData.ClientId) {
  throw new Error('Cognito environment variables not configured');
}

export const userPool = new CognitoUserPool(poolData);
```

2. Create src/contexts/AuthContext.tsx with full implementation from 05-RESEARCH.md:
- AuthProvider component with useState for isAuthenticated, isLoading, user
- useEffect to check for existing session on mount
- signIn function using authenticateUser with USER_SRP_AUTH
- signOut function using globalSignOut
- getAccessToken function for API calls
- Export AuthContext, AuthProvider, and useAuth hook

Handle newPasswordRequired callback (for first login after admin creates user):
```typescript
newPasswordRequired: (userAttributes) => {
  // For MVP, prompt user to change password
  // Store cognitoUser for completeNewPasswordChallenge
  setNeedsNewPassword(true);
  setTempUser(cognitoUser);
}
```

3. Create src/hooks/useAuth.ts:
```typescript
import { useContext } from 'react';
import { AuthContext } from '../contexts/AuthContext';

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
}
```
  </action>
  <verify>TypeScript compiles: `cd admin && npx tsc --noEmit`</verify>
  <done>AuthContext provides signIn, signOut, getAccessToken; useAuth hook works</done>
</task>

<task type="auto">
  <name>Task 3: Create login page and protected app shell</name>
  <files>admin/src/pages/LoginPage.tsx, admin/src/components/layout/AppShell.tsx, admin/src/App.tsx, admin/src/main.tsx, admin/src/lib/queryClient.ts</files>
  <action>
1. Create src/lib/queryClient.ts:
```typescript
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      gcTime: 1000 * 60 * 30,   // 30 minutes
      retry: 1,
      refetchOnWindowFocus: true,
    },
  },
});
```

2. Create src/pages/LoginPage.tsx:
- Form with email and password inputs (Tailwind styled)
- Submit handler calls signIn from useAuth
- Loading state during sign-in
- Error display for failed login
- Handle newPasswordRequired state (show password change form)
- On success, navigate to /leads

```typescript
function LoginPage() {
  const { signIn, isLoading } = useAuth();
  const navigate = useNavigate();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    try {
      await signIn(email, password);
      navigate('/leads');
    } catch (err) {
      setError(err.message || 'Login failed');
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <form onSubmit={handleSubmit} className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 className="text-2xl font-bold mb-6 text-center">Tropico Retreats Admin</h1>
        {error && <div className="bg-red-50 text-red-700 p-3 rounded mb-4">{error}</div>}
        {/* email input, password input, submit button */}
      </form>
    </div>
  );
}
```

3. Create src/components/layout/AppShell.tsx:
- Header with logo/title and sign out button
- Main content area (children or Outlet)
- Protected: if not authenticated, redirect to /login

```typescript
function AppShell() {
  const { isAuthenticated, isLoading, signOut, user } = useAuth();
  const navigate = useNavigate();

  if (isLoading) {
    return <div className="min-h-screen flex items-center justify-center">Loading...</div>;
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-xl font-semibold">Tropico Retreats</h1>
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-600">{user?.getUsername()}</span>
            <button onClick={signOut} className="text-sm text-gray-600 hover:text-gray-900">
              Sign out
            </button>
          </div>
        </div>
      </header>
      <main className="max-w-7xl mx-auto px-4 py-6">
        <Outlet />
      </main>
    </div>
  );
}
```

4. Update src/App.tsx with routing:
```typescript
import { BrowserRouter, Routes, Route, Navigate } from 'react-router';
import { QueryClientProvider } from '@tanstack/react-query';
import { AuthProvider } from './contexts/AuthContext';
import { queryClient } from './lib/queryClient';
import LoginPage from './pages/LoginPage';
import AppShell from './components/layout/AppShell';

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>
        <BrowserRouter>
          <Routes>
            <Route path="/login" element={<LoginPage />} />
            <Route path="/" element={<AppShell />}>
              <Route index element={<Navigate to="/leads" replace />} />
              <Route path="leads" element={<div>Leads list (Plan 06)</div>} />
              <Route path="leads/:id" element={<div>Lead detail (Plan 07)</div>} />
            </Route>
          </Routes>
        </BrowserRouter>
      </AuthProvider>
    </QueryClientProvider>
  );
}
```

5. Update src/main.tsx to import index.css for Tailwind
  </action>
  <verify>
- `cd admin && npm run dev` starts without errors
- Navigate to http://localhost:5174/login shows login form
- Invalid credentials show error message
- Valid credentials (admin@tropicoretreat.com) redirect to /leads
- /leads shows placeholder and header with sign out
- Sign out redirects to /login
  </verify>
  <done>Login page works with Cognito; AppShell protects routes; sign out works</done>
</task>

</tasks>

<verification>
All checks:
1. `cd admin && npm run dev` starts on port 5174
2. Login with admin@tropicoretreat.com works
3. After login, shows AppShell with header
4. Sign out clears session and redirects to login
5. Refreshing /leads keeps user logged in (session persisted)
6. Accessing /leads without auth redirects to /login
</verification>

<success_criteria>
1. Vite app runs with React 19, TypeScript, Tailwind
2. AuthContext provides signIn, signOut, getAccessToken, isAuthenticated
3. LoginPage authenticates with Cognito User Pool
4. AppShell protects routes, shows header with user and sign out
5. TanStack Query client configured
6. Placeholder routes for /leads and /leads/:id
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-dashboard/05-04-SUMMARY.md`
</output>
